<!-- builder_main.html v12.4-es5r1 (2025-09-16) : ES5互換 + 場所ベース折りたたみ + ローダ堅牢化 + 背景エフェクト数修正 -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>表情＋エフェクト＋背景ビルダー（ライト UI・カテゴリ直読）</title>
<style>
  :root{--fg:#222; --muted:#667085; --ok:#16a34a; --bad:#dc2626; --empty:#2563eb; --bg:#fff; --chip:#f2f4f7; --line:#e5e7eb; --ink:#0b1220; --inkfg:#e6edf3;}
  html,body{margin:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif}
  .wrap{max-width:860px;margin:16px auto;padding:0 12px calc(120px + 32vh)}
  h1{font-size:22px;line-height:1.35;margin:10px 0 16px}
  .row{display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff}
  .badge{padding:6px 10px;border-radius:999px;font-size:12px;background:var(--chip)}
  .b-ok{color:#fff;background:var(--ok)} .b-bad{color:#fff;background:var(--bad)} .b-empty{color:#fff;background:var(--empty)}
  .readline{font-size:14px;color:#111}
  .meter-all{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden}
  .meter-fill{height:100%;width:0;background:linear-gradient(90deg,#93c5fd,#22c55e)}
  details{background:#fff;border:1px solid var(--line);border-radius:12px;margin:12px 0}
  summary{padding:14px 16px;cursor:pointer;list-style:none;font-weight:700}
  details[open]>summary{border-bottom:1px solid #eef0f2}
  .panel{padding:10px 14px}
  .log{background:#0b1220;color:#e6edf3;border-radius:12px;padding:14px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;line-height:1.35;max-height:28vh;overflow:auto}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .chk{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px}
  .foot{position:fixed;z-index:10;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);padding:10px}
  .foot .row{margin:0}
  .out{width:100%;min-height:110px;border:1px solid var(--line);border-radius:12px;padding:10px}
  .meterRow{display:flex;align-items:center;gap:10px;margin:8px 0}
  .meterBar{flex:1;height:6px;border-radius:999px;background:#eef2f7;position:relative;overflow:hidden}
  .meterFill{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#b5e3c3,#16a34a)}
  .slot{min-width:92px;text-align:right;color:#6b7280;font-size:12px}
  .subhead{font-size:14px;color:#334155;margin:6px 0 8px;font-weight:700}
  .toast{position:fixed;left:50%;bottom:96px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:10000;font-size:14px}
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>表情＋エフェクト＋背景ビルダー（ライト UI・カテゴリ直読）</h1>

  <div class="row">
    <button id="reloadBtn" class="btn">再読込</button>
    <span class="badge b-ok" id="cntOK">成功 0</span>
    <span class="badge b-bad" id="cntNG">失敗 0</span>
    <span class="badge b-empty" id="cntEMPTY">空 1200</span>
  </div>

  <div class="row" style="align-items:center">
    <span class="readline">読み込み: <span id="totalRead">0</span> / <span id="totalMax">1200</span></span>
    <div class="meter-all" style="flex:1;min-width:200px"><div id="overallFill" class="meter-fill"></div></div>
  </div>

  <details id="d-meters">
    <summary>▼ 各カテゴリの進行・ログ（成功/失敗/空＋ログ）</summary>
    <div class="panel">
      <div id="meters"></div>
      <div class="subhead">読み込みログ</div>
      <div id="log" class="log">(ログはここに出ます)</div>
    </div>
  </details>

  <details id="d-presets"><summary>▼ プリセット <span id="num-presets">0</span></summary>
    <div class="panel"><div id="list-presets" class="grid"></div></div>
  </details>

  <details id="d-expr"><summary>▼ 表情 <span id="num-expr">0</span></summary>
    <div class="panel">
      <details><summary>✨ 喜 <span id="n-joy">0</span></summary><div class="panel"><div id="g-joy" class="grid"></div></div></details>
      <details><summary>💢 怒 <span id="n-anger">0</span></summary><div class="panel"><div id="g-anger" class="grid"></div></div></details>
      <details><summary>😢 哀 <span id="n-sad">0</span></summary><div class="panel"><div id="g-sad" class="grid"></div></div></details>
      <details><summary>🎵 楽 <span id="n-happy">0</span></summary><div class="panel"><div id="g-happy" class="grid"></div></div></details>
      <details><summary>❤️ heart <span id="n-heart">0</span></summary><div class="panel"><div id="g-heart" class="grid"></div></div></details>

      <details><summary>👀 視線系 <span id="n-eyes">0</span></summary><div class="panel"><div id="g-eyes" class="grid"></div></div></details>
      <details><summary>💧 涙系 <span id="n-tear">0</span></summary><div class="panel"><div id="g-tear" class="grid"></div></div></details>
      <details><summary>👄 口元系 <span id="n-mouth">0</span></summary><div class="panel"><div id="g-mouth" class="grid"></div></div></details>
      <details><summary>❓ 困惑 <span id="n-confuse">0</span></summary><div class="panel"><div id="g-confuse" class="grid"></div></div></details>
      <details><summary>😳 緊張 <span id="n-tense">0</span></summary><div class="panel"><div id="g-tense" class="grid"></div></div></details>
      <details><summary>☺️ 恥じらい <span id="n-shy">0</span></summary><div class="panel"><div id="g-shy" class="grid"></div></div></details>
      <details><summary>▶ その他 <span id="n-etc">0</span></summary><div class="panel"><div id="g-etc" class="grid"></div></div></details>
    </div>
  </details>

  <details id="d-eff-subject"><summary>▼ 被写体エフェクト <span id="num-eff-subject">0</span></summary>
    <div class="panel">
      <details><summary>✨ リング・輝き <span id="n-eff-ring">0</span></summary><div class="panel"><div id="g-eff-ring" class="grid"></div></div></details>
      <details><summary>🧵 ライン／スピード線 <span id="n-eff-line">0</span></summary><div class="panel"><div id="g-eff-line" class="grid"></div></div></details>
      <details><summary>🌫️ パーティクル・粉塵 <span id="n-eff-particle">0</span></summary><div class="panel"><div id="g-eff-particle" class="grid"></div></div></details>
      <details><summary>💡 光・グロー／反射 <span id="n-eff-light">0</span></summary><div class="panel"><div id="g-eff-light" class="grid"></div></div></details>
      <details><summary>🌊 歪み・液体・波紋 <span id="n-eff-distort">0</span></summary><div class="panel"><div id="g-eff-distort" class="grid"></div></div></details>
      <details><summary>🧩 その他 <span id="n-eff-etc">0</span></summary><div class="panel"><div id="g-eff-etc" class="grid"></div></div></details>
    </div>
  </details>

  <details id="d-bg"><summary>▼ 背景 <span id="num-bg">0</span></summary>
    <div class="panel">
      <details><summary>📍 場所 <span id="n-bg-place">0</span></summary>
        <div class="panel"><div id="g-bg-place" class="grid"></div></div>
      </details>
      <details><summary>🧩 背景エフェクト <span id="n-bg-eff">0</span></summary>
        <div class="panel"><div id="g-bg-eff" class="grid"></div></div>
      </details>
    </div>
  </details>

  <details id="d-pose"><summary>▼ ポーズ <span id="num-pose">0</span></summary>
    <div class="panel"><div id="list-pose" class="grid"></div></div>
  </details>
  <details id="d-hair"><summary>▼ 髪型 <span id="num-hair">0</span></summary>
    <div class="panel" id="hair-groups"><div id="list-hair" class="grid" style="display:none"></div></div>
  </details>
</div>

<div class="foot">
  <div class="row">
    <button id="gen" class="btn">タグ生成</button>
    <button id="reset" class="btn">リセット</button>
    <button id="copy" class="btn">コピー</button>
  </div>
  <textarea id="out" class="out" placeholder="generated tags will appear here..."></textarea>
</div>

<div id="toast" class="toast">done</div>

<script>
(function(){
  function $(s){return document.querySelector(s)}
  function arr(x){return Array.isArray(x)?x:[]}
  function get(obj, path, dft){var v=obj,i=0;while(v&&i<path.length){v=v[path[i++]]}return v==null?dft:v}
  function hitAny(s,ws){for(var i=0;i<ws.length;i++){if(s.indexOf(ws[i])>-1)return true}return false}

  var BASE="./";
  var FILES={
    presets:function(i){return BASE+"presets_part"+i+".js"},
    faith:function(i){return BASE+"faith_part"+i+".js"},
    background:function(i){return BASE+"background_part"+i+".js"},
    effect:function(i){return BASE+"effect_part"+i+".js"},
    pose:function(i){return BASE+"pose_part"+i+".js"},
    hair:function(i){return BASE+"hair_part"+i+".js"}
  };
  var CAT_ORDER=["presets","faith","background","effect","pose","hair"];
  var CAT_SLOTS={presets:200,faith:200,background:200,effect:200,pose:200,hair:200};
  var TOTAL_SLOTS=CAT_SLOTS.presets+CAT_SLOTS.faith+CAT_SLOTS.background+CAT_SLOTS.effect+CAT_SLOTS.pose+CAT_SLOTS.hair;

  window.__parts=window.__parts||{presets:{},faith:{},background:{},effect:{},pose:{},hair:{}};
  function __ensure(p){if(!window.__parts[p]) window.__parts[p]={}; return window.__parts[p];}
  window.__registerPresetPart=function(a,b,c){
    if(arguments.length===3 && String(a).toLowerCase()==='presets'){ __ensure('presets')[b]=c; return; }
    if(arguments.length>=2 && typeof a==='string' && /^presets_part\d+$/i.test(a)){ __ensure('presets')[a]=b; return; }
    __ensure('presets')[a]=b;
  };
  window.__registerPromptPart=function(n,d){__ensure("faith")[n]=d};
  window.__registerBackgroundPart=function(n,d){__ensure("background")[n]=d};
  window.__registerEffectPart=function(n,d){__ensure("effect")[n]=d};
  window.__registerPosePart=function(n,d){__ensure("pose")[n]=d};
  window.__registerHairPart=function(n,d){__ensure("hair")[n]=d};

  var log=$('#log'), overallFill=$('#overallFill');
  $('#cntEMPTY').textContent='空 '+TOTAL_SLOTS; $('#totalMax').textContent=TOTAL_SLOTS;

  var metersBox=$('#meters'), meterMap={};
  function addMeterRow(label,key){
    var row=document.createElement('div'); row.className='meterRow';
    row.innerHTML='<div style="min-width:120px">'+label+'</div>'
    +'<div class="meterBar"><div class="meterFill" id="fill-'+key+'"></div></div>'
    +'<div class="slot"><span id="ok-'+key+'" class="badge b-ok">成功 0</span></div>'
    +'<div class="slot"><span id="ng-'+key+'" class="badge b-bad">失敗 0</span></div>'
    +'<div class="slot"><span id="em-'+key+'" class="badge b-empty">空 '+CAT_SLOTS[key]+'</span></div>';
    metersBox.appendChild(row);
    meterMap[key]={fill:row.querySelector('#fill-'+key),ok:row.querySelector('#ok-'+key),ng:row.querySelector('#ng-'+key),em:row.querySelector('#em-'+key),okn:0,ngn:0,emn:CAT_SLOTS[key],total:CAT_SLOTS[key]};
  }
  for(var iadd=0;iadd<CAT_ORDER.length;iadd++) addMeterRow(CAT_ORDER[iadd],CAT_ORDER[iadd]);

  var totalOk=0,totalNg=0,totalEm=TOTAL_SLOTS,totalRead=0;
  $('#cntOK').textContent='成功 '+totalOk; $('#cntNG').textContent='失敗 '+totalNg; $('#totalRead').textContent=totalRead;
  function writeLog(s){ if(!log) return; if(log.textContent)log.textContent+='\n'; log.textContent+=s; log.scrollTop=log.scrollHeight; }
  window.onerror=function(msg){ try{writeLog('[JS Error] '+msg)}catch(e){} };
  if(window.addEventListener){ window.addEventListener('unhandledrejection', function(e){ try{writeLog('[Promise Rejection] '+String(e&&e.reason))}catch(_){} }) }

  function uiMeterUpdate(key){
    var m=meterMap[key];
    m.ok.textContent='成功 '+m.okn; m.ng.textContent='失敗 '+m.ngn; m.em.textContent='空 '+m.emn;
    var prog=(CAT_SLOTS[key]-m.emn)/m.total; m.fill.style.inset='0 '+((1-prog)*100)+'% 0 0';
    $('#cntOK').textContent='成功 '+totalOk; $('#cntNG').textContent='失敗 '+totalNg; $('#cntEMPTY').textContent='空 '+totalEm; $('#totalRead').textContent=totalRead;
    var overall=(TOTAL_SLOTS-totalEm)/TOTAL_SLOTS; overallFill.style.width=(overall*100).toFixed(1)+'%';
  }

  function loadViaTag(url, timeout){
    return new Promise(function(res){
      var done=false, s=document.createElement('script');
      s.async=true; s.src=url + (url.indexOf('?')>-1?'&':'?') + 'v='+(new Date().getTime());
      s.onload=function(){ if(done) return; done=true; res('ok'); };
      s.onerror=function(){ if(done) return; done=true; res('empty'); };
      document.head.appendChild(s);
      setTimeout(function(){ if(done) return; done=true; res('hang'); }, timeout||2500);
    });
  }
  function loadViaFetchBlob(url){
    if(!window.fetch||!window.Blob||!URL||!URL.createObjectURL) return Promise.resolve('empty');
    return fetch(url,{cache:'no-store'}).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(function(code){
        var blob=new Blob([code],{type:'text/javascript'}); var u=URL.createObjectURL(blob);
        return loadViaTag(u,2500).then(function(r){ try{URL.revokeObjectURL(u)}catch(_){ } return r==='ok'?'ok':'empty'; });
      }).catch(function(){ return 'empty'; });
  }
  function tryLoad(url){
    return loadViaTag(url,2500).then(function(r){
      if(r==='ok') return 'ok';
      if(r==='hang'){ writeLog('⚠ 読み込み待ちタイムアウト → fetch+blob に切替: '+url); return loadViaFetchBlob(url); }
      return r;
    });
  }

  function mkChk(id,label){
    var lab=document.createElement('label'); lab.className='chk';
    lab.innerHTML='<input type="checkbox" data-id="'+id+'"><span>'+ (label||id) +'</span>';
    return lab;
  }

  var el={
    presets:$('#list-presets'),
    joy:$('#g-joy'), anger:$('#g-anger'), sad:$('#g-sad'), happy:$('#g-happy'), heart:$('#g-heart'),
    eyes:$('#g-eyes'), tear:$('#g-tear'), mouth:$('#g-mouth'), confuse:$('#g-confuse'), tense:$('#g-tense'), shy:$('#g-shy'), etc:$('#g-etc'),
    numPresets:$('#num-presets'), numExpr:$('#num-expr'),
    effRing:$('#g-eff-ring'), effLine:$('#g-eff-line'), effParticle:$('#g-eff-particle'), effLight:$('#g-eff-light'), effDistort:$('#g-eff-distort'), effEtc:$('#g-eff-etc'),
    nEffRing:$('#n-eff-ring'), nEffLine:$('#n-eff-line'), nEffParticle:$('#n-eff-particle'), nEffLight:$('#n-eff-light'), nEffDistort:$('#n-eff-distort'), nEffEtc:$('#n-eff-etc'),
    numEffSubject:$('#num-eff-subject'),
    bgPlace:$('#g-bg-place'), bgEff:$('#g-bg-eff'), nBgPlace:$('#n-bg-place'), nBgEff:$('#n-bg-eff'), numBg:$('#num-bg'),
    listPose:$('#list-pose'), listHair:$('#list-hair'), numPose:$('#num-pose'), numHair:$('#num-hair')
  };

  var emotionDict={
    joy:['smile','grin','laugh','wink','happy','smirk','喜','嬉','楽','ニヤ'],
    anger:['angry','furious','grit','gritted','frown','annoyed','irritated','怒','ムッ'],
    sad:['sad','cry','teary','tears','涙','泣','哀'],
    happy:['relax','cheer','sparkle','楽','ふわ','calm','serene','composed'],
    heart:['heart','love','♡','❤','ラブ'],
    eyes:['eye','eyes','gaze','look','視線','見開','細め','上目','blink','drowsy','star','glimmer','gleam'],
    tear:['tear','涙','うる','潤','teary'],
    mouth:['mouth','lip','唇','bite','smug','bashful','tease'],
    confuse:['confuse','困惑','bewilder'],
    tense:['tense','緊張','nervous','stiffen','freeze'],
    shy:['shy','はにか','恥','blush','bashful']
  };
  var effBGHint=['bg','background','backdrop','sakura','petals','leaves','snow','rain','drizzle','mist','haze','veil','cloud','starscape','city','street','forest','sea','mountain','desert','screen'];
  var effSubjectGroups=[
    {key:'ring',words:['ring','rim','crown','halo','sparkle','gloss','bokeh']},
    {key:'line',words:['line','線','burst','speed','slash','zigzag']},
    {key:'particle',words:['dust','spark','ember','particle','snow','ashes','filament']},
    {key:'light',words:['light','glow','shine','gleam','glimmer','gloss','highlight','flare']},
    {key:'distort',words:['distort','warp','ripple','wave','liquid','ghost','trench','veil']}
  ];

  function renderAll(){
    var pCount=0, k;
    for(k in window.__parts.presets){
      var pp = get(window.__parts,['presets',k,'presets'],[]);
      for(var i=0;i<arr(pp).length;i++){ var p=pp[i]; el.presets.appendChild(mkChk(p.id,p.label||p.id)); pCount++; }
    }
    el.numPresets.textContent=pCount;

    var eCnt={joy:0,anger:0,sad:0,happy:0,heart:0,eyes:0,tear:0,mouth:0,confuse:0,tense:0,shy:0,etc:0,total:0};
    var exprMap={joy:el.joy,anger:el.anger,sad:el.sad,happy:el.happy,heart:el.heart,eyes:el.eyes,tear:el.tear,mouth:el.mouth,confuse:el.confuse,tense:el.tense,shy:el.shy,etc:el.etc};
    for(k in window.__parts.faith){
      var cats = get(window.__parts,['faith',k,'categories'],[]);
      for(var ci=0;ci<arr(cats).length;ci++){
        var c=cats[ci]; var items=arr(c.items);
        for(var ii=0;ii<items.length;ii++){
          var it=items[ii]; var text=(String(it.label||'')).toLowerCase(); var grp='etc';
          var order1=['heart','anger','sad','joy','happy']; for(var j=0;j<order1.length;j++){ var g=order1[j]; if(hitAny(text,emotionDict[g])){ grp=g; break } }
          if(grp==='etc'){ var order2=['eyes','tear','mouth','confuse','tense','shy']; for(var j2=0;j2<order2.length;j2++){ var g2=order2[j2]; if(hitAny(text,emotionDict[g2])){ grp=g2; break } } }
          exprMap[grp].appendChild(mkChk(it.id,it.label||it.id)); eCnt[grp]++; eCnt.total++;
        }
      }
    }
    $('#num-expr').textContent=eCnt.total;
    $('#n-joy').textContent=eCnt.joy; $('#n-anger').textContent=eCnt.anger; $('#n-sad').textContent=eCnt.sad; $('#n-happy').textContent=eCnt.happy; $('#n-heart').textContent=eCnt.heart;
    $('#n-eyes').textContent=eCnt.eyes; $('#n-tear').textContent=eCnt.tear; $('#n-mouth').textContent=eCnt.mouth; $('#n-confuse').textContent=eCnt.confuse; $('#n-tense').textContent=eCnt.tense; $('#n-shy').textContent=eCnt.shy; $('#n-etc').textContent=eCnt.etc;

    var bgPlaceCount=0,bgEff=0, collectedPlace=[];
    function walkBg(cat, inheritedEff){
      var name=String(get(cat,['name'],''));
      var isEffect = inheritedEff || /effect|エフェクト/i.test(name);
      var items=arr(cat.items);
      for(var bi=0;bi<items.length;bi++){
        var it=items[bi];
        if(isEffect){ $('#g-bg-eff').appendChild(mkChk(it.id,it.label||it.id)); bgEff++; }
        else { collectedPlace.push({id:it.id,label:it.label||it.id}); }
      }
      var subs=arr(cat.categories);
      for(var si=0;si<subs.length;si++){ walkBg(subs[si], isEffect) }
    }
    for(k in window.__parts.background){
      var bgcats = get(window.__parts,['background',k,'categories'],[]);
      for(var bci=0;bci<arr(bgcats).length;bci++){ walkBg(bgcats[bci], false) }
    }
    var baseDefs = [
      { key:'sea',      title:'🌊 海 / Sea',       baseTag:'sea',      kw:['sea','ocean','beach','coast','coastal','bay','harbor','harbour','reef','pier','marina','lighthouse','waikiki','copacabana','bondi','santorini','haeundae'] },
      { key:'mountain', title:'⛰ 山 / Mountain',   baseTag:'mountain', kw:['mountain','mt.','peak','ridge','cliff','alps','andes','himalaya','fuji','yosemite','zion','monument','volcano','caldera','crater','canyon'] },
      { key:'forest',   title:'🌲 森林 / Forest',   baseTag:'forest',   kw:['forest','wood','bamboo','jungle','rainforest','mangrove','yakushima','grove'] },
      { key:'others',   title:'▶ その他 / Others', baseTag:null,       kw:[] }
    ];
    (function buildBgBaseGroups(){
      var host = el.bgPlace; host.innerHTML='';
      var groups={}, i;
      for(i=0;i<baseDefs.length;i++){
        var d=baseDefs[i], dd=document.createElement('details'); dd.open=false;
        var sm=document.createElement('summary'); var cnt=document.createElement('span'); cnt.id='cnt-bg-'+d.key; cnt.textContent='0';
        sm.textContent=d.title+' '; sm.appendChild(cnt);
        var panel=document.createElement('div'); panel.className='panel';
        var grid=document.createElement('div'); grid.className='grid'; grid.id='g-bg-'+d.key;
        panel.appendChild(grid); dd.appendChild(sm); dd.appendChild(panel);
        host.appendChild(dd);
        groups[d.key]={grid:grid,countEl:cnt,n:0,def:d};
        if(d.baseTag){ grid.appendChild(mkChk(d.baseTag, d.title.replace(/^[^ ]+ /,'').split('/')[0].trim()+' / '+d.baseTag)); }
      }
      for(i=0;i<collectedPlace.length;i++){
        var it=collectedPlace[i];
        var t=(String(it.label)+' '+String(it.id)).toLowerCase();
        var key='others';
        for(var j=0;j<baseDefs.length;j++){
          var d2=baseDefs[j]; if(d2.key==='others') continue;
          var kws=d2.kw; for(var kx=0;kx<kws.length;kx++){ if(t.indexOf(kws[kx])>-1){ key=d2.key; break; } }
          if(key!=='others') break;
        }
        groups[key].grid.appendChild(mkChk(it.id,it.label)); groups[key].n++; bgPlaceCount++;
      }
      for(var gk in groups){ groups[gk].countEl.textContent=groups[gk].n; }
    })();
    $('#n-bg-place').textContent=bgPlaceCount; $('#n-bg-eff').textContent=bgEff; $('#num-bg').textContent=bgPlaceCount+bgEff;

    var cRing=0,cLine=0,cParticle=0,cLight=0,cDistort=0,cEtc=0, effSub=0;
    for(k in window.__parts.effect){
      var ecats = get(window.__parts,['effect',k,'categories'],[]);
      for(var ei=0;ei<arr(ecats).length;ei++){
        var c2=ecats[ei]; var items2=arr(c2.items);
        for(var eii=0;eii<items2.length;eii++){
          var it2=items2[eii]; var text2=(String(it2.label||'')+' '+it2.id).toLowerCase();
          if(hitAny(text2,effBGHint)){ $('#g-bg-eff').appendChild(mkChk(it2.id,it2.label||it2.id)); bgEff++; continue; }
          var grp='etc'; for(var gi=0;gi<effSubjectGroups.length;gi++){ if(hitAny(text2,effSubjectGroups[gi].words)){ grp=effSubjectGroups[gi].key; break; } }
          (function put(node,grp){
            var map={ring:el.effRing,line:el.effLine,particle:el.effParticle,light:el.effLight,distort:el.effDistort,etc:el.effEtc};
            var cnt={ring:el.nEffRing,line:el.nEffLine,particle:el.nEffParticle,light:el.nEffLight,distort:el.nEffDistort,etc:el.nEffEtc};
            (map[grp||'etc']).appendChild(node); cnt[grp||'etc'].textContent=(+cnt[grp||'etc'].textContent||0)+1;
          })(mkChk(it2.id,it2.label||it2.id),grp);
          if(grp==='ring')cRing++; else if(grp==='line')cLine++; else if(grp==='particle')cParticle++; else if(grp==='light')cLight++; else if(grp==='distort')cDistort++; else cEtc++;
          effSub++;
        }
      }
    }
    $('#n-eff-ring').textContent=cRing; $('#n-eff-line').textContent=cLine; $('#n-eff-particle').textContent=cParticle; $('#n-eff-light').textContent=cLight; $('#n-eff-distort').textContent=cDistort; $('#n-eff-etc').textContent=cEtc;
    $('#num-eff-subject').textContent=effSub;
    $('#n-bg-eff').textContent=bgEff; $('#num-bg').textContent=bgPlaceCount+bgEff; // [CHANGE] 背景エフェクト数を再反映
  }

  function loadCategory(catKey){
    return new Promise(function(resolve){
      var max=CAT_SLOTS[catKey]; writeLog('=== '+catKey+' 読み開始 ==='); var hitEmpty=false; var i=1;
      function step(){
        if(i>max){ writeLog('=== '+catKey+' 読み終了 ==='); resolve(); return; }
        if(hitEmpty){ i++; step(); return; }
        tryLoad(FILES[catKey](i)).then(function(res){
          if(res==='ok'){ meterMap[catKey].okn++; totalOk++; meterMap[catKey].emn--; totalEm--; writeLog('OK : ['+catKey+'] part '+i+' : OK'); totalRead++; }
          else if(res==='empty'){ hitEmpty=true; writeLog('なし : ['+catKey+'] part '+i+' : なし'); }
          else{ meterMap[catKey].ngn++; totalNg++; meterMap[catKey].emn--; totalEm--; writeLog('エラー: ['+catKey+'] part '+i+' : 失敗'); totalRead++; }
          uiMeterUpdate(catKey); i++; step();
        });
      }
      step();
    });
  }

  function run(){
    try{
      log.textContent=''; totalOk=0; totalNg=0; totalEm=TOTAL_SLOTS; totalRead=0;
      for(var i=0;i<CAT_ORDER.length;i++){ var k=CAT_ORDER[i]; meterMap[k].okn=0; meterMap[k].ngn=0; meterMap[k].emn=CAT_SLOTS[k]; uiMeterUpdate(k); }
      var p=Promise.resolve();
      for(var j=0;j<CAT_ORDER.length;j++){ (function(key){ p=p.then(function(){ return loadCategory(key); }); })(CAT_ORDER[j]); }
      p.then(function(){ writeLog('=== ロード終了 ==='); renderAll(); });
    }catch(e){ writeLog('[致命的エラー] '+(e&&e.message?e.message:String(e))); }
  }

  var toast=$('#toast'), toastTimer=null;
  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); if(toastTimer) clearTimeout(toastTimer); toastTimer=setTimeout(function(){toast.classList.remove('show')},3000); }
  $('#reset').addEventListener('click', function(){ var nodes=document.querySelectorAll('input[type="checkbox"]'); for(var i=0;i<nodes.length;i++){nodes[i].checked=false} $('#out').value=''; showToast('リセットしました'); });
  $('#copy').addEventListener('click', function(){ if(navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText($('#out').value||''); showToast('コピーしました'); } });

  function formatHairTokens(ids){
    function lower(s){return String(s||'').toLowerCase()}
    function hasHairWord(t){return t.indexOf(' hair')>-1 || /-hair$/.test(t) || /^hair-/.test(t)}
    var colorMatchers=['pastel','metallic','glow','bioluminescent','phosphor','radioactive','neon','gradient','ombre','uv-reactive','highlight','gloss','smoky','uv-reactive yellow','uv-reactive orange','ash smoky gray','chocolate brown gloss','wine red gloss','blonde highlights','brown highlights'];
    var colorRegexTail=/(black|brown|blonde|red|silver|white|gold|blue|green|pink|purple|pearl|copper|chrome|emerald)$/;
    function isColor(id){ var t=lower(id); return colorMatchers.some(function(k){return t.indexOf(k)>-1}) || colorRegexTail.test(t) || /^hair-/.test(t) || /-hair$/.test(t) }
    function isStyle(id){ return /ponytail|twin|bun|updo|chignon|bob|pixie|pageboy|bang|fringe|braid|afro|mohawk|dread|undercut|hime|nihongami|mullet|lob|shag|wolf|wavy|curly|straight|perm/.test(lower(id)) }
    var mapped = ids.map(function(raw){ var id=String(raw), t=lower(raw); return ((isColor(id)||isStyle(id)) && !hasHairWord(t)) ? id+' hair' : id; });
    return mapped.filter(function(tok){return lower(tok).trim()!=='hair'});
  }
  $('#gen').addEventListener('click', function(){
    var ids=[], nodes=document.querySelectorAll('input[type="checkbox"]:checked');
    for(var i=0;i<nodes.length;i++){ ids.push(nodes[i].dataset.id) }
    $('#out').value = formatHairTokens(ids).join(', ');
    showToast('タグ生成しました');
  });

  $('#reloadBtn').addEventListener('click', run);
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', run); }
  else { run(); }
})();
</script>

<!-- Part番号オート記憶（既存そのまま） -->
<script>
(function(){
  var INITIAL = { presets:33, faith:32, effect:33, background:1, pose:0, hair:0 };
  var KEY='pbPartCounters';
  var load=function(){ try{ return JSON.parse(localStorage.getItem(KEY))||{}; }catch(e){ return {}; } };
  var save=function(obj){ localStorage.setItem(KEY,JSON.stringify(obj)); };
  var state=Object.assign({presets:0,faith:0,effect:0,background:0,pose:0,hair:0},load());
  for(var k in INITIAL){ state[k]=Math.max(Number(state[k]||0),Number(INITIAL[k]||0)); } save(state);
  function parseName(name, fallbackCat){
    var cat=fallbackCat||'', idx=0;
    if(typeof name==='string' && name.indexOf('_part')>-1){
      var m=name.match(/^([a-zA-Z]+)_part(\d+)$/); if(m){cat=m[1]; idx=parseInt(m[2],10)||0;}
    } else if(typeof name==='string' && /^part\d+$/.test(name)){
      idx=parseInt(name.replace('part',''),10)||0;
    }
    var norm={presets:'presets',faith:'faith',effect:'effect',background:'background',pose:'pose',hair:'hair',prompt:'faith'};
    cat=norm[cat]||(norm[fallbackCat]||''); return {cat:cat,idx:idx};
  }
  function bump(cat,idx){
    if(!cat||!idx) return; var cur=Number(state[cat]||0);
    if(idx>cur){ state[cat]=idx; save(state); }
  }
  var _orig={
    preset:window.__registerPresetPart, faith:window.__registerPromptPart, effect:window.__registerEffectPart,
    bg:window.__registerBackgroundPart, pose:window.__registerPosePart, hair:window.__registerHairPart
  };
  window.__registerPresetPart=function(name,data){
    try{var z=parseName(name,'presets'); bump(z.cat,z.idx);}catch(e){}
    return _orig.preset&&_orig.preset.apply(this,arguments);
  };
  window.__registerPromptPart=function(name,data){
    try{var z=parseName(name,'faith'); bump(z.cat,z.idx);}catch(e){}
    return _orig.faith&&_orig.faith.apply(this,arguments);
  };
  window.__registerEffectPart=function(name,data){
    try{var z=parseName(name,'effect'); bump(z.cat,z.idx);}catch(e){}
    return _orig.effect&&_orig.effect.apply(this,arguments);
  };
  window.__registerBackgroundPart=function(name,data){
    try{var z=parseName(name,'background'); bump(z.cat,z.idx);}catch(e){}
    return _orig.bg&&_orig.bg.apply(this,arguments);
  };
  window.__registerPosePart=function(name,data){
    try{var z=parseName(name,'pose'); bump(z.cat,z.idx);}catch(e){}
    return _orig.pose&&_orig.pose.apply(this,arguments);
  };
  window.__registerHairPart=function(name,data){
    try{var z=parseName(name,'hair'); bump(z.cat,z.idx);}catch(e){}
    return _orig.hair&&_orig.hair.apply(this,arguments);
  };
  window.__pbGetNextIndex=function(cat){
    var n=Number((load()[cat]||state[cat])||0); return (n+1);
  };
})();
</script>
</body>
</html>