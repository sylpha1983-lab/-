<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>プロンプトビルダー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  :root{--ok:#2ecc71;--ng:#e74c3c;--em:#3498db}
  body{font-family:sans-serif;margin:1rem}
  .badges{display:flex;gap:.5rem;align-items:center;margin:8px 0;position:sticky;top:0;z-index:5;background:#fff;padding:6px 8px;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .badge{padding:4px 10px;border-radius:999px;font-weight:700;font-size:.9rem}
  .badge.ok{background:var(--ok);color:#fff}
  .badge.ng{background:var(--ng);color:#fff}
  .badge.em{background:var(--em);color:#fff}
  #log{height:160px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;background:#111;color:#e9f1ff;border-radius:8px;padding:8px;border:none;margin:8px 0}
  .btn-slim{padding:.45rem .9rem;border-radius:.8rem;background:#333;color:#fff;border:none}
  #pb-ui-host{margin:12px 0; display:none;}
  #ui-host{margin:12px 0}
  </style>
</head>
<body>

  <h1>プロンプトビルダー</h1>

  <div class="badges" id="badges">
    <span class="badge ok" id="b-ok">成功 0</span>
    <span class="badge ng" id="b-ng">失敗 0</span>
    <span class="badge em" id="b-em">空 0</span>
    <button id="reloadBtn" class="btn-slim">再読込</button>
    <label style="margin-left:auto">
      <input type="checkbox" id="autoScroll" checked> ログ自動スクロール
    </label>
  </div>

  <pre id="log">(ログはここに出ます)
[VisualSync] LUT applied: lut-warm → target=preview-area
[VisualSync] Tone sync: {brightness:120, contrast:110,...} → target=preview-area
  </pre>

  <section id="pb-ui-host"></section>

  <script>
  function writeLog(s){
    const log=document.getElementById("log");
    if(!log)return;
    log.textContent+=(log.textContent?"\n":"")+s;
    const as=document.getElementById("autoScroll");
    if(as&&as.checked)log.scrollTop=log.scrollHeight;
  }

  let __OK=0,__NG=0,__EM=0;
  function __bump(kind){
    if(kind==='ok')__OK++;else if(kind==='ng')__NG++;else __EM++;
    const ok=document.getElementById('b-ok'),
          ng=document.getElementById('b-ng'),
          em=document.getElementById('b-em');
    if(ok)ok.textContent='成功 '+__OK;
    if(ng)ng.textContent='失敗 '+__NG;
    if(em)em.textContent='空 '+__EM;
  }

  window.onPartResult=function(kind,cat,part){
    __bump(kind);
    try{writeLog(`[meter] ${kind} : [${cat}] part ${part}`);}catch(_){}
  }

  async function loadCategory(cat,baseName){
    let n=1;
    while(true){
      const url=`${baseName}_part${n}.js`;
      try{
        const resp=await fetch(url,{method:"HEAD"});
        if(!resp.ok){window.onPartResult?.('em',cat,n);break;}
        const s=document.createElement('script');
        s.src=url+'?v='+Date.now();
        s.onerror=()=>{window.onPartResult?.('ng',cat,n);};
        document.body.appendChild(s);
        window.onPartResult?.('ok',cat,n);
        n++;
      }catch(e){
        writeLog(`[error] load fail ${url}: ${e&&e.message||e}`);
        window.onPartResult?.('ng',cat,n);
        break;
      }
    }
  }

  function run(){
    __OK = __NG = __EM = 0;
    document.getElementById("b-ok").textContent = "成功 0";
    document.getElementById("b-ng").textContent = "失敗 0";
    document.getElementById("b-em").textContent = "空 0";

    writeLog('[debug] run() started');
    loadCategory('presets','presets');
    loadCategory('faith','faith');
    loadCategory('background','background');
    loadCategory('effect','effect');
    loadCategory('pose','pose');
    loadCategory('hair','hair');

    try{if(typeof window.__loadExtParts==='function')window.__loadExtParts();}catch(_){}
  }

  window.run=run;
  document.getElementById('reloadBtn')?.addEventListener('click',()=>location.reload());
  </script>

  <script data-ext src="ext_manifest.v1.js"></script>
  <script data-ext src="ext_manifest_loader.v1.js"></script>

  <script>
  (function(){
    var tried=false,t0=Date.now();
    function kick(){
      if(tried)return;
      if(typeof window.run==="function"){
        tried=true;
        try{window.run();}catch(e){console.error("[debug] run() failed:",e);}
        return;
      }
      if(Date.now()-t0<2000){setTimeout(kick,100);}
      else if(typeof window.run!=="function"){writeLog("[debug] window.run not found");}
    }
    if(document.readyState==="complete"){kick();}
    else{window.addEventListener("load",kick,{once:true});}
  })();
  </script>

  <div id="ui-host"></div>

  <!-- ✅ 読み込みチェッカー安定化修正版 -->
  <script>
  let __loaderStable = false;

  window.addEventListener("loader:updated", function(e) {
    const s = e.detail;
    const ok = document.getElementById("b-ok"),
          ng = document.getElementById("b-ng"),
          em = document.getElementById("b-em");

    if (!__loaderStable) {
      __OK = __NG = __EM = 0;
      if (ok) ok.textContent = "成功 0";
      if (ng) ng.textContent = "失敗 0";
      if (em) em.textContent = "空 0";
      __loaderStable = true;
      writeLog("[meter] loader initialized (stable mode)");
    }

    try {
      if (s && typeof s.success === "number") {
        if (ok) ok.textContent = "成功 " + s.success;
        if (ng) ng.textContent = "失敗 " + s.error;
        if (em) em.textContent = "空 " + s.empty;
      }
    } catch (err) {
      console.warn("[meter] update failed", err);
    }
  });
  </script>

</body>
</html>