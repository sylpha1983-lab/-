<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è¡¨æƒ…ï¼‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¤‡åˆãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆå–œæ€’å“€æ¥½ãƒ»åˆæœŸã‚¯ãƒ­ãƒ¼ã‚ºï¼ãƒãƒ¼ã‚ºãƒ»é«ªå‹å¯¾å¿œï¼‰</title>
<style>
  :root{--gap:10px;--pad:10px}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111;margin:10px}
  h1{font-size:1.15rem;margin:6px 0 12px}
  .card{padding:var(--pad);border:1px solid #eee;border-radius:12px;background:#fff;margin:10px 0}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap}
  input[type="search"],input[type="text"]{width:100%;padding:.7em;border:1px solid #ccc;border-radius:10px}
  .btn{padding:.65em 1em;border:1px solid #ccc;border-radius:10px;background:#f8f8f8}
  .btn:active{transform:translateY(1px)}
  details{border:1px solid #eee;border-radius:12px;padding:6px;margin:8px 0;background:#fff}
  summary{cursor:pointer;font-weight:700;list-style:none}
  summary::-webkit-details-marker{display:none}
  label.item{display:flex;align-items:center;gap:8px;padding:6px 2px;line-height:1.25}
  .muted{color:#666}
  textarea{width:100%;min-height:140px;padding:10px;border:1px solid #ccc;border-radius:12px}
  .pill{font-size:.8rem;border:1px solid #ddd;border-radius:999px;padding:.15em .55em;background:#fafafa}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .count{font-variant-numeric:tabular-nums}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;font-size:.9rem;white-space:pre-wrap}
  .ok{color:#067}.ng{color:#b00}.empty{color:#666}
</style>
</head>
<body>
  <h1>è¡¨æƒ…ï¼‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¤‡åˆãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆå–œæ€’å“€æ¥½ãƒ»åˆæœŸã‚¯ãƒ­ãƒ¼ã‚ºï¼ãƒãƒ¼ã‚ºãƒ»é«ªå‹å¯¾å¿œï¼‰</h1>

  <!-- æŠ˜ã‚ŠãŸãŸã‚ã‚‹èª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆUIãã®ã¾ã¾ï¼‰ -->
  <div class="card">
    <details id="checkerBox">
      <summary>èª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚«ãƒ¼ï¼š <span id="loadSummary" class="pill count">â€”</span></summary>
      <div id="loadLog" class="mono muted"></div>
    </details>
  </div>

  <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆå–œæ€’å“€æ¥½ï¼‹heartã§æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="card">
    <input id="presetSearch" type="search" placeholder="ãƒ—ãƒªã‚»ãƒƒãƒˆæ¤œç´¢ / Preset search (JP/EN)">
    <details id="presetsBox">
      <summary>ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆâœ¨ å–œ / ğŸ’¢ æ€’ / ğŸ˜¢ å“€ / ğŸµ æ¥½ / â¤ï¸ heartãƒ»åˆæœŸé–‰ï¼‰ <span id="presetCount" class="pill count"></span></summary>
      <details><summary>âœ¨ å–œ <span id="pcJoy" class="pill count"></span></summary><div id="presetJoy"></div></details>
      <details><summary>ğŸ’¢ æ€’ <span id="pcAnger" class="pill count"></span></summary><div id="presetAnger"></div></details>
      <details><summary>ğŸ˜¢ å“€ <span id="pcSad" class="pill count"></span></summary><div id="presetSad"></div></details>
      <details><summary>ğŸµ æ¥½ <span id="pcFun" class="pill count"></span></summary><div id="presetFun"></div></details>
      <details><summary>â¤ï¸ heart <span id="pcHeart" class="pill count"></span></summary><div id="presetHeart"></div></details>
      <details><summary>ãã®ä»– <span id="pcOther" class="pill count"></span></summary><div id="presetOther"></div></details>
    </details>
  </div>

  <!-- è¡¨æƒ…ï¼ˆå–œæ€’å“€æ¥½ï¼‹heartã§æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="card">
    <input id="exprSearch" type="search" placeholder="è¡¨æƒ…æ¤œç´¢ / Expression search (JP/EN)">
    <details id="exprBox">
      <summary>è¡¨æƒ…ï¼ˆâœ¨ å–œ / ğŸ’¢ æ€’ / ğŸ˜¢ å“€ / ğŸµ æ¥½ / â¤ï¸ heartãƒ»åˆæœŸé–‰ï¼‰ <span id="exprCount" class="pill count"></span></summary>
      <details><summary>âœ¨ å–œ <span id="ecJoy" class="pill count"></span></summary><div id="exprJoy"></div></details>
      <details><summary>ğŸ’¢ æ€’ <span id="ecAnger" class="pill count"></span></summary><div id="exprAnger"></div></details>
      <details><summary>ğŸ˜¢ å“€ <span id="ecSad" class="pill count"></span></summary><div id="exprSad"></div></details>
      <details><summary>ğŸµ æ¥½ <span id="ecFun" class="pill count"></span></summary><div id="exprFun"></div></details>
      <details><summary>â¤ï¸ heart <span id="ecHeart" class="pill count"></span></summary><div id="exprHeart"></div></details>
    </details>
  </div>

  <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆç³»çµ±ã”ã¨æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="card">
    <input id="effSearch" type="search" placeholder="ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ¤œç´¢ / Effect search (JP/EN)">
    <details id="effBox">
      <summary>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå…‰ï¼ç·šï¼ç²’å­ï¼å¤©å€™ï¼VFXâ€¦ãƒ»åˆæœŸé–‰ï¼‰ <span id="effCount" class="pill count"></span></summary>
      <div id="catalogEff"></div>
    </details>
  </div>

  <!-- ãƒãƒ¼ã‚ºï¼ˆã‚«ãƒ†ã‚´ãƒªã”ã¨æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="card">
    <input id="poseSearch" type="search" placeholder="ãƒãƒ¼ã‚ºæ¤œç´¢ / Pose search (JP/EN)">
    <details id="poseBox">
      <summary>ãƒãƒ¼ã‚ºï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»åˆæœŸé–‰ï¼‰ <span id="poseCount" class="pill count"></span></summary>
      <div id="catalogPose"></div>
    </details>
  </div>

  <!-- é«ªå‹ï¼ˆã‚«ãƒ†ã‚´ãƒªã”ã¨æŠ˜ã‚ŠãŸãŸã¿ â†’ ã•ã‚‰ã«è¦ªã‚°ãƒ«ãƒ¼ãƒ—ã§æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="card">
    <input id="hairSearch" type="search" placeholder="é«ªå‹æ¤œç´¢ / Hair search (JP/EN)">
    <details id="hairBox">
      <summary>é«ªå‹ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»åˆæœŸé–‰ï¼‰ <span id="hairCount" class="pill count"></span></summary>
      <div id="catalogHair"></div>
    </details>
  </div>

  <!-- Extra -->
  <div class="card">
    <details id="extraBox">
      <summary>Extraï¼ˆã‚«ã‚¿ãƒ­ã‚°å¤– / Not in catalogãƒ»åˆæœŸé–‰ï¼‰ <span id="extraCount" class="pill count">0</span></summary>
      <div id="extraBody"></div>
    </details>
  </div>

  <!-- å‡ºåŠ› -->
  <div class="card">
    <div class="row flex-between">
      <div class="row">
        <button id="btnGen" class="btn">ã‚¿ã‚°ç”Ÿæˆ</button>
        <button id="btnReset" class="btn">ãƒªã‚»ãƒƒãƒˆï¼ˆExtraå«ã‚€ï¼‰</button>
        <button id="btnCopy" class="btn">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <small class="muted">å‡ºåŠ›ã¯è‹±èªã‚¿ã‚°ï¼ˆidï¼‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ç”Ÿæˆã€‚UIã¯æ—¥è‹±ä½µè¨˜ã€‚</small>
    </div>
    <textarea id="out" placeholder="generated tags will appear here..."></textarea>
  </div>

<script>
/* ============================================================
   ãƒ¬ã‚¸ã‚¹ãƒˆãƒªï¼ˆæ—§/æ–°/åˆ¥åIDã™ã¹ã¦å¸åï¼‰â€»UIå¤‰æ›´ãªã—
============================================================ */
window.__registerPromptPart = (id, data) => {
  const pb = (window.promptBuilder = window.promptBuilder || {});
  pb[id] = data;
  const alias = window.__CURRENT_LOAD_NAME;
  if (alias && !pb[alias]) pb[alias] = data;
};
window.registerPromptPart = window.__registerPromptPart;
window.__registerPromptPack = window.__registerPromptPart;

window.__registerPosePart = (id, data) => {
  const p = (window.poseBuilder = window.poseBuilder || {});
  p[id] = data;
  const alias = window.__CURRENT_LOAD_NAME;
  if (alias && !p[alias]) p[alias] = data;
};
window.__registerHairPart = (id, data) => {
  const h = (window.hairBuilder = window.hairBuilder || {});
  h[id] = data;
  const alias = window.__CURRENT_LOAD_NAME;
  if (alias && !h[alias]) h[alias] = data;
};

/* ===== å‚ç…§ ===== */
const loadLog      = document.getElementById('loadLog');
const loadSummary  = document.getElementById('loadSummary');

const presetCountEl = document.getElementById('presetCount');
const exprCountEl   = document.getElementById('exprCount');
const effCountEl    = document.getElementById('effCount');
const poseCountEl   = document.getElementById('poseCount');
const hairCountEl   = document.getElementById('hairCount');

const presetAreas = {
  joy:    document.getElementById('presetJoy'),
  anger:  document.getElementById('presetAnger'),
  sad:    document.getElementById('presetSad'),
  fun:    document.getElementById('presetFun'),
  heart:  document.getElementById('presetHeart'),
  other:  document.getElementById('presetOther'),
};
const presetAreaCounts = {
  joy: document.getElementById('pcJoy'),
  anger: document.getElementById('pcAnger'),
  sad: document.getElementById('pcSad'),
  fun: document.getElementById('pcFun'),
  heart: document.getElementById('pcHeart'),
  other: document.getElementById('pcOther'),
};

const exprAreas = {
  joy:   document.getElementById('exprJoy'),
  anger: document.getElementById('exprAnger'),
  sad:   document.getElementById('exprSad'),
  fun:   document.getElementById('exprFun'),
  heart: document.getElementById('exprHeart'),
};
const exprAreaCounts = {
  joy: document.getElementById('ecJoy'),
  anger: document.getElementById('ecAnger'),
  sad: document.getElementById('ecSad'),
  fun: document.getElementById('ecFun'),
  heart: document.getElementById('ecHeart'),
};

const catalogEffRoot  = document.getElementById('catalogEff');
const catalogPoseRoot = document.getElementById('catalogPose');
const catalogHairRoot = document.getElementById('catalogHair');

const extraBody = document.getElementById('extraBody');
const extraCount = document.getElementById('extraCount');
const out = document.getElementById('out');

const checkboxMap = new Map();
const presetBoxMap = new Map();
const extraSet = new Set();

/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
let allCategories = [];      // Expressions + Effects
let allPresets = [];
let allPoseCategories = [];  // Poses only
let allHairCategories = [];  // Hair only

/* ===== æ—§â†’æ–° å¤‰æ›ï¼ˆmixæ—§å½¢å¼ï¼‰ ===== */
function convertOldExpressionEffectsToNew(obj){
  const categories = [];
  if (Array.isArray(obj.expressions) && obj.expressions.length){
    categories.push({
      name: 'Expressions / è¡¨æƒ…',
      items: obj.expressions.map(e=>({ id: e.id, label: `${(e.jp||e.label||e.id)} / ${e.id}` }))
    });
  }
  if (Array.isArray(obj.effects) && obj.effects.length){
    const groups = {};
    obj.effects.forEach(e=>{
      const key = e.category || 'Effects / ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ';
      if(!groups[key]) groups[key]=[];
      groups[key].push({ id: e.id, label: `${(e.jp||e.label||e.id)} / ${e.id}` });
    });
    Object.keys(groups).forEach(k=> categories.push({ name:k, items:groups[k] }));
  }
  const presets = Array.isArray(obj.presets) ? obj.presets.map(p=>({
    id: p.id, label: p.label || p.id,
    tags: [...new Set([...(p.tags||[]), ...(p.expressions||[]), ...(p.effects||[])])]
  })) : [];
  return { categories, presets };
}

/* ===== pose/hair æ­£è¦åŒ– ===== */
function normalizeGenericPart(data){
  if (!data) return null;
  if (Array.isArray(data.categories)) {
    data.categories.forEach(c=>{
      c.items = (c.items||[]).map(it=>({ id: it.id, label: it.label || `${it.id}` }));
    });
    return data;
  }
  if (data.name && Array.isArray(data.items)){
    return { categories:[{ name:data.name, items:data.items.map(it=>({id:it.id,label:it.label||it.id})) }] };
  }
  return null;
}

/* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆmix: part1-200ã€pose: pose_part1-200ã€hair: hair_part1-200ï¼‰ ===== */
async function loadPartsSeq(from=1,to=200){
  window.promptBuilder = window.promptBuilder || {};
  const addLog = (line,cls)=>{const d=document.createElement('div');d.textContent=line; if(cls)d.className=cls; loadLog.appendChild(d);};
  let ok=0, ng=0, empty=0;

  for (let i=from;i<=to;i++){
    const name=`part${i}`;
    try{
      if (document.getElementById(`loader-${name}`)){ ensureRegisteredMix(name)?(ok++):(empty++); addLog(`${name}: OK (cached)`,'ok'); continue; }
      const url=`${name}.js`;
      const res = await fetch(url,{cache:'no-store'});
      if (res.status===404){ empty++; addLog(`${name}: EMPTYï¼ˆæœªé…ç½®ï¼‰`,'empty'); continue; }

      const js=await res.text();
      const s=document.createElement('script');
      s.id=`loader-${name}`;
      window.__CURRENT_LOAD_NAME = name;
      s.textContent=js+`\n//# sourceURL=${url}`;
      document.head.appendChild(s);
      window.__CURRENT_LOAD_NAME = null;

      ensureRegisteredMix(name)?(ok++):(empty++, addLog(`${name}: EMPTYï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã‚ãŸãŒæœªç™»éŒ²ï¼‰`,'empty')); 
    }catch(e){ ng++; addLog(`${name}: ERROR ${e.message}`,'ng'); }
  }
  loadSummary.dataset.mixOk = ok;
  loadSummary.dataset.mixNg = ng;
  loadSummary.dataset.mixEmpty = empty;
  updateLoadSummary();
}

async function loadPoseSeq(from=1,to=200){
  window.poseBuilder = window.poseBuilder || {};
  const addLog = (line,cls)=>{const d=document.createElement('div');d.textContent=line; if(cls)d.className=cls; loadLog.appendChild(d);};
  let ok=0, ng=0, empty=0;

  for (let i=from;i<=to;i++){
    const id=`pose_part${i}`;
    try{
      if (document.getElementById(`loader-${id}`)){ ensureRegisteredPose(id)?(ok++):(empty++); addLog(`${id}: OK (cached)`,'ok'); continue; }
      const url=`${id}.js`;
      const res=await fetch(url,{cache:'no-store'});
      if (res.status===404){ empty++; addLog(`${id}: EMPTYï¼ˆæœªé…ç½®ï¼‰`,'empty'); continue; }

      const js=await res.text();
      const s=document.createElement('script');
      s.id=`loader-${id}`;
      window.__CURRENT_LOAD_NAME = id;
      s.textContent=js+`\n//# sourceURL=${url}`;
      document.head.appendChild(s);
      window.__CURRENT_LOAD_NAME = null;

      ensureRegisteredPose(id)?(ok++):(empty++, addLog(`${id}: EMPTYï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã‚ãŸãŒæœªç™»éŒ²ï¼‰`,'empty'));
    }catch(e){ ng++; addLog(`${id}: ERROR ${e.message}`,'ng'); }
  }
  loadSummary.dataset.poseOk = ok;
  loadSummary.dataset.poseNg = ng;
  loadSummary.dataset.poseEmpty = empty;
  updateLoadSummary();
}

async function loadHairSeq(from=1,to=200){
  window.hairBuilder = window.hairBuilder || {};
  const addLog = (line,cls)=>{const d=document.createElement('div');d.textContent=line; if(cls)d.className=cls; loadLog.appendChild(d);};
  let ok=0, ng=0, empty=0;

  for (let i=from;i<=to;i++){
    const id=`hair_part${i}`;
    try{
      if (document.getElementById(`loader-${id}`)){ ensureRegisteredHair(id)?(ok++):(empty++); addLog(`${id}: OK (cached)`,'ok'); continue; }
      const url=`${id}.js`;
      const res=await fetch(url,{cache:'no-store'});
      if (res.status===404){ empty++; addLog(`${id}: EMPTYï¼ˆæœªé…ç½®ï¼‰`,'empty'); continue; }

      const js=await res.text();
      const s=document.createElement('script');
      s.id=`loader-${id}`;
      window.__CURRENT_LOAD_NAME = id;
      s.textContent=js+`\n//# sourceURL=${url}`;
      document.head.appendChild(s);
      window.__CURRENT_LOAD_NAME = null;

      ensureRegisteredHair(id)?(ok++):(empty++, addLog(`${id}: EMPTYï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã‚ãŸãŒæœªç™»éŒ²ï¼‰`,'empty'));
    }catch(e){ ng++; addLog(`${id}: ERROR ${e.message}`,'ng'); }
  }
  loadSummary.dataset.hairOk = ok;
  loadSummary.dataset.hairNg = ng;
  loadSummary.dataset.hairEmpty = empty;
  updateLoadSummary();
}

function updateLoadSummary(){
  const mixOk=Number(loadSummary.dataset.mixOk||0),
        mixNg=Number(loadSummary.dataset.mixNg||0),
        mixEm=Number(loadSummary.dataset.mixEmpty||0),
        poseOk=Number(loadSummary.dataset.poseOk||0),
        poseNg=Number(loadSummary.dataset.poseNg||0),
        poseEm=Number(loadSummary.dataset.poseEmpty||0),
        hairOk=Number(loadSummary.dataset.hairOk||0),
        hairNg=Number(loadSummary.dataset.hairNg||0),
        hairEm=Number(loadSummary.dataset.hairEmpty||0);
  loadSummary.textContent = `mix: æˆåŠŸ${mixOk}/å¤±æ•—${mixNg}/ç©º${mixEm} ï½œ pose: æˆåŠŸ${poseOk}/å¤±æ•—${poseNg}/ç©º${poseEm} ï½œ hair: æˆåŠŸ${hairOk}/å¤±æ•—${hairNg}/ç©º${hairEm}`;
}

/* ===== ensureï¼ˆç™»éŒ²ç¢ºèªï¼‰ ===== */
function ensureRegisteredMix(name){
  if (window.promptBuilder && window.promptBuilder[name]) return true;
  if (window.expressionEffects && window.expressionEffects[name]){
    window.promptBuilder[name] = convertOldExpressionEffectsToNew(window.expressionEffects[name]);
    return true;
  }
  const maybe = window[name];
  if (maybe && (maybe.categories || maybe.expressions || maybe.effects)){
    window.promptBuilder[name] = maybe.categories ? maybe : convertOldExpressionEffectsToNew(maybe);
    return true;
  }
  return false;
}
function ensureRegisteredPose(id){
  if (window.poseBuilder && window.poseBuilder[id]) return true;
  if (window[id]){ const norm=normalizeGenericPart(window[id]); if (norm){ window.poseBuilder[id]=norm; return true; } }
  if (window.poseParts && window.poseParts[id]){ const norm=normalizeGenericPart(window.poseParts[id]); if (norm){ window.poseBuilder[id]=norm; return true; } }
  return false;
}
function ensureRegisteredHair(id){
  if (window.hairBuilder && window.hairBuilder[id]) return true;
  if (window[id]){ const norm=normalizeGenericPart(window[id]); if (norm){ window.hairBuilder[id]=norm; return true; } }
  if (window.hairParts && window.hairParts[id]){ const norm=normalizeGenericPart(window.hairParts[id]); if (norm){ window.hairBuilder[id]=norm; return true; } }
  return false;
}

/* ===== çµ±åˆ ===== */
function integrateMix(){
  const parts = window.promptBuilder || {};
  const catMap = new Map();
  const presetArr = [];

  Object.keys(parts).sort().forEach(k=>{
    const p = parts[k]||{};
    (p.categories||[]).forEach(cat=>{
      if (!cat || !cat.name) return;
      const name = cat.name;
      if (!catMap.has(name)) catMap.set(name,{name,items:[]});
      const bucket = catMap.get(name);
      (cat.items||[]).forEach(it=>{
        if (!it || !it.id) return;
        if (!bucket.items.some(x=>x.id===it.id)){
          bucket.items.push({id: it.id, label: it.label || it.id});
        }
      });
    });
    (p.presets||[]).forEach(pr=>{
      if (!pr || !pr.id) return;
      let tags = [];
      if (Array.isArray(pr.tags))        tags = tags.concat(pr.tags);
      if (Array.isArray(pr.expressions)) tags = tags.concat(pr.expressions);
      if (Array.isArray(pr.effects))     tags = tags.concat(pr.effects);
      tags = [...new Set(tags.filter(Boolean))];
      presetArr.push({id: pr.id, label: pr.label || pr.id, tags});
    });
  });

  allCategories = [...catMap.values()];
  allCategories.sort((a,b)=>{
    const ae = a.name.startsWith('Expressions') ? 0 : 1;
    const be = b.name.startsWith('Expressions') ? 0 : 1;
    return ae-be || a.name.localeCompare(b.name);
  });
  allPresets = presetArr;
}

function integratePose(){
  const parts = window.poseBuilder || {};
  const catMap = new Map();
  Object.keys(parts).sort().forEach(k=>{
    (parts[k].categories||[]).forEach(cat=>{
      if (!cat || !cat.name) return;
      if (!catMap.has(cat.name)) catMap.set(cat.name,{name:cat.name,items:[]});
      const b=catMap.get(cat.name);
      (cat.items||[]).forEach(it=>{
        if (it && it.id && !b.items.some(x=>x.id===it.id)){
          b.items.push({id:it.id,label:it.label||it.id});
        }
      });
    });
  });
  allPoseCategories = [...catMap.values()].sort((a,b)=>a.name.localeCompare(b.name));
}
function integrateHair(){
  const parts = window.hairBuilder || {};
  const catMap = new Map();
  Object.keys(parts).sort().forEach(k=>{
    (parts[k].categories||[]).forEach(cat=>{
      if (!cat || !cat.name) return;
      if (!catMap.has(cat.name)) catMap.set(cat.name,{name:cat.name,items:[]});
      const b=catMap.get(cat.name);
      (cat.items||[]).forEach(it=>{
        if (it && it.id && !b.items.some(x=>x.id===it.id)){
          b.items.push({id:it.id,label:it.label||it.id});
        }
      });
    });
  });
  allHairCategories = [...catMap.values()].sort((a,b)=>a.name.localeCompare(b.name));
}

/* ===== é«ªå‹ã®â€œã‚‚ã†ä¸€æ®µæŠ˜ã‚ŠãŸãŸã¿â€ç”¨ã‚°ãƒ«ãƒ¼ãƒ—åˆ¤å®š ===== */
function hairGroupName(name){
  const n = (name||'').toLowerCase();
  if (/ponytail/.test(n)) return 'Ponytails / ãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«ç³»';
  if (/color|colors|ã‚«ãƒ©ãƒ¼/.test(n)) return 'Colors / ã‚«ãƒ©ãƒ¼ç³»';
  if (/highlight|mesh|gradation|gradient|two[- ]?tone|neon|glow|ã‚°ãƒ©ãƒ‡|ãƒã‚¤ãƒ©ã‚¤ãƒˆ|ãƒ„ãƒ¼ãƒˆãƒ¼ãƒ³|ç™ºå…‰/.test(n))
    return 'Highlights & Gradations / ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ»ã‚°ãƒ©ãƒ‡ç³»';
  if (/bangs|long|short|medium|updo|style|ã‚¹ã‚¿ã‚¤ãƒ«|å‰é«ª|ãƒ­ãƒ³ã‚°|ã‚·ãƒ§ãƒ¼ãƒˆ|ãƒŸãƒ‡ã‚£ã‚¢ãƒ |ã¾ã¨ã‚|å·»ã|ã‚¢ãƒƒãƒ—/.test(n))
    return 'Styles / ã‚¹ã‚¿ã‚¤ãƒ«ç³»';
  if (/accessor|é£¾|ã‚¢ã‚¯ã‚»/.test(n)) return 'Accessories / ã‚¢ã‚¯ã‚»ç³»';
  if (/traditional|ethnic|cultural|å’Œ|æ°‘æ—|ä¼çµ±|æ–‡åŒ–/.test(n))
    return 'Traditional & Cultural / ä¼çµ±ãƒ»æ–‡åŒ–ç³»';
  if (/fantasy|magic|gothic|dark|otherworld|futur|sci[- ]?fi|cyber|sf|ç•°ä¸–ç•Œ|æœªæ¥|å¹»æƒ³|é­”æ³•|ã‚´ã‚·ãƒƒã‚¯|ãƒ€ãƒ¼ã‚¯/.test(n))
    return 'Fantasy / Sci-Fi / Gothic';
  return 'Other / ãã®ä»–';
}

/* ===== UIæ§‹ç¯‰ ===== */
function moodBucketOf(label){
  const raw=(label||'');
  const s=raw.toLowerCase();
  if (/(heart|ãƒãƒ¼ãƒˆ|â¤ï¸)/i.test(raw)) return 'heart';
  if (/(å–œ|å®‰å µ|å¾®ç¬‘|æ˜Ÿ|é›ª|å…‰)/.test(raw)||/(joy|reliev|cheer|spark)/.test(s)) return 'joy';
  if (/(æ€’|æ±ºæ„|åµ|é›·|ç ‚|ç†±)/.test(raw)||/(storm|thunder|gust|scorch|resolve)/.test(s)) return 'anger';
  if (/(å“€|é™è¬|æ¶™|å¯‚)/.test(raw)||/(melan|quiet|calm|serene)/.test(s)) return 'sad';
  if (/(æ¥½|éŠ|æˆ¯|æ³¡|ãã‚‰)/.test(raw)||/(fun|play|bubble|sparkle)/.test(s)) return 'fun';
  return 'fun';
}

function buildPresets(){
  Object.values(presetAreas).forEach(el=> el && (el.innerHTML=''));
  presetBoxMap.clear();

  allPresets.forEach(p=>{
    const bucket = moodBucketOf(p.label);
    const area = presetAreas[bucket] || presetAreas.other;
    const lab = document.createElement('label'); lab.className='item';
    const cb  = document.createElement('input'); cb.type='checkbox'; cb.dataset.pid = p.id;
    lab.appendChild(cb);
    lab.appendChild(document.createTextNode(`${p.label} / ${p.id}`));
    area.appendChild(lab);
    presetBoxMap.set(p.id, cb);
    cb.addEventListener('change', ()=> applyPreset(p, cb.checked));
  });

  const counts = {joy:0,anger:0,sad:0,fun:0,heart:0,other:0};
  allPresets.forEach(p=> counts[moodBucketOf(p.label)] = (counts[moodBucketOf(p.label)]||0)+1);
  presetAreaCounts.joy.textContent    = counts.joy;
  presetAreaCounts.anger.textContent  = counts.anger;
  presetAreaCounts.sad.textContent    = counts.sad;
  presetAreaCounts.fun.textContent    = counts.fun;
  presetAreaCounts.heart.textContent  = counts.heart;
  presetAreaCounts.other.textContent  = counts.other;
  presetCountEl.textContent = `å…¨${allPresets.length}`;
}

function buildExpressionsByMood(){
  Object.values(exprAreas).forEach(el=> el && (el.innerHTML=''));
  const exprCat = allCategories.find(c=>c.name.startsWith('Expressions'));
  const items = exprCat?.items || [];
  let counts = {joy:0,anger:0,sad:0,fun:0,heart:0};
  items.forEach(it=>{
    const bucket = moodBucketOf(it.label||it.id);
    const area = exprAreas[bucket] || exprAreas.fun;
    const lab = document.createElement('label'); lab.className='item';
    const cb  = document.createElement('input'); cb.type='checkbox';
    cb.dataset.id = it.id; cb.value = it.id;
    lab.appendChild(cb);
    lab.appendChild(document.createTextNode(`${it.label || it.id} / ${it.id}`));
    area.appendChild(lab);
    checkboxMap.set(it.id, cb);
    cb.addEventListener('change', syncPresetsFromCatalog);
    counts[bucket] = (counts[bucket]||0)+1;
  });
  exprCountEl.textContent = `å…¨${items.length}`;
  exprAreaCounts.joy.textContent   = counts.joy||0;
  exprAreaCounts.anger.textContent = counts.anger||0;
  exprAreaCounts.sad.textContent   = counts.sad||0;
  exprAreaCounts.fun.textContent   = counts.fun||0;
  exprAreaCounts.heart.textContent = counts.heart||0;
}

function buildEffects(){
  catalogEffRoot.innerHTML='';
  allCategories.filter(c=>!c.name.startsWith('Expressions')).forEach(cat=>{
    const wrap=document.createElement('details'); wrap.open=false;
    const sum=document.createElement('summary'); sum.textContent=cat.name;
    wrap.appendChild(sum);
    (cat.items||[]).forEach(it=>{
      const lab=document.createElement('label'); lab.className='item';
      const cb=document.createElement('input'); cb.type='checkbox';
      cb.dataset.id=it.id; cb.value=it.id;
      lab.appendChild(cb);
      lab.appendChild(document.createTextNode(`${it.label || it.id} / ${it.id}`));
      wrap.appendChild(lab);
      checkboxMap.set(it.id, cb);
      cb.addEventListener('change', syncPresetsFromCatalog);
    });
    catalogEffRoot.appendChild(wrap);
  });
  const effItems = allCategories.filter(c=>!c.name.startsWith('Expressions')).reduce((n,c)=>n+(c.items?.length||0),0);
  effCountEl.textContent = `å…¨${effItems}`;
}

function buildPoses(){
  catalogPoseRoot.innerHTML='';
  allPoseCategories.forEach(cat=>{
    const wrap=document.createElement('details'); wrap.open=false;
    const sum=document.createElement('summary'); sum.textContent=cat.name;
    wrap.appendChild(sum);
    (cat.items||[]).forEach(it=>{
      const lab=document.createElement('label'); lab.className='item';
      const cb=document.createElement('input'); cb.type='checkbox';
      cb.dataset.id=it.id; cb.value=it.id;
      lab.appendChild(cb);
      lab.appendChild(document.createTextNode(`${it.label || it.id} / ${it.id}`));
      wrap.appendChild(lab);
      checkboxMap.set(it.id, cb);
      cb.addEventListener('change', syncPresetsFromCatalog);
    });
    catalogPoseRoot.appendChild(wrap);
  });
  const total = allPoseCategories.reduce((n,c)=>n+(c.items?.length||0),0);
  poseCountEl.textContent = `å…¨${total}`;
}

/* â˜…â˜…â˜… é«ªå‹ï¼šã‚‚ã†ä¸€æ®µã®æŠ˜ã‚ŠãŸãŸã¿ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—â†’ã‚«ãƒ†ã‚´ãƒªâ†’ã‚¿ã‚°ï¼‰ â˜…â˜…â˜… */
function buildHair(){
  catalogHairRoot.innerHTML='';

  // 1) ã‚«ãƒ†ã‚´ãƒªã‚’ã‚°ãƒ«ãƒ¼ãƒ—åã«ãƒãƒƒãƒ—
  const groupMap = new Map(); // groupName -> { wrap, inner, count }
  function ensureGroup(name){
    if (!groupMap.has(name)){
      const gWrap = document.createElement('details'); gWrap.open=false;
      const gSum  = document.createElement('summary'); gSum.textContent = name + ' ';
      const gCnt  = document.createElement('span'); gCnt.className='pill count'; gCnt.textContent='0';
      gSum.appendChild(gCnt);
      gWrap.appendChild(gSum);
      const gBody = document.createElement('div');
      gWrap.appendChild(gBody);
      catalogHairRoot.appendChild(gWrap);
      groupMap.set(name,{wrap:gWrap, body:gBody, cnt:gCnt, num:0});
    }
    return groupMap.get(name);
  }

  // 2) å„ã‚«ãƒ†ã‚´ãƒªã‚’ã‚°ãƒ«ãƒ¼ãƒ—å†…ã® details ã¨ã—ã¦ä½œæˆ
  allHairCategories.forEach(cat=>{
    const gName = hairGroupName(cat.name);
    const g = ensureGroup(gName);
    const wrap=document.createElement('details'); wrap.open=false;
    const sum=document.createElement('summary'); sum.textContent=cat.name;
    wrap.appendChild(sum);

    (cat.items||[]).forEach(it=>{
      const lab=document.createElement('label'); lab.className='item';
      const cb=document.createElement('input'); cb.type='checkbox';
      cb.dataset.id=it.id; cb.value=it.id;
      lab.appendChild(cb);
      lab.appendChild(document.createTextNode(`${it.label || it.id} / ${it.id}`));
      wrap.appendChild(lab);
      checkboxMap.set(it.id, cb);
      cb.addEventListener('change', syncPresetsFromCatalog);
    });

    g.body.appendChild(wrap);
    g.num += 1;
  });

  // 3) ã‚°ãƒ«ãƒ¼ãƒ—ã®ä»¶æ•°ãƒãƒƒã‚¸ã‚’æ›´æ–°
  groupMap.forEach(g=> g.cnt.textContent = g.num);

  // åˆè¨ˆä»¶æ•°ï¼ˆå¾“æ¥é€šã‚Šï¼šé …ç›®ç·æ•°ï¼‰
  const total = allHairCategories.reduce((n,c)=>n+(c.items?.length||0),0);
  hairCountEl.textContent = `å…¨${total}`;
}

/* ===== Extra / ãƒ—ãƒªã‚»ãƒƒãƒˆé€£å‹• / æ¤œç´¢ / å‡ºåŠ› ===== */
function addExtra(id,label){
  if (checkboxMap.has(id) || extraSet.has(id)) return;
  extraSet.add(id);
  const labEl = document.createElement('label'); labEl.className='item';
  const cbox  = document.createElement('input'); cbox.type='checkbox';
  cbox.checked = true; cbox.dataset.id=id; cbox.value=id; cbox.dataset.extra='1';
  labEl.appendChild(cbox);
  labEl.appendChild(document.createTextNode(label?`${label} / ${id}`:id));
  extraBody.appendChild(labEl);
  extraCount.textContent = String(extraSet.size);
}
function applyPreset(p,checked){
  const ids=(p.tags||[]).filter(Boolean);
  ids.forEach(id=>{
    const t=checkboxMap.get(id);
    if (t){ t.checked=checked; t.dispatchEvent(new Event('change',{bubbles:false})); }
    else if (checked){ addExtra(id); }
    else{
      const box=[...extraBody.querySelectorAll('input[type=checkbox]')].find(x=>x.dataset.id===id);
      if (box) box.checked=false;
    }
  });
  syncPresetsFromCatalog();
}
function filterList(rootEl,q){
  const qq=(q||'').trim().toLowerCase();
  rootEl.querySelectorAll('label.item').forEach(l=>{
    l.style.display = l.textContent.toLowerCase().includes(qq) ? '' : 'none';
  });
}
document.getElementById('presetSearch').addEventListener('input',e=>{
  filterList(document.getElementById('presetsBox'), e.target.value);
});
document.getElementById('exprSearch').addEventListener('input',e=>{
  filterList(document.getElementById('exprBox'), e.target.value);
});
document.getElementById('effSearch').addEventListener('input',e=>{
  filterList(document.getElementById('effBox'), e.target.value);
});
document.getElementById('poseSearch').addEventListener('input',e=>{
  filterList(document.getElementById('poseBox'), e.target.value);
});
document.getElementById('hairSearch').addEventListener('input',e=>{
  filterList(document.getElementById('hairBox'), e.target.value);
});
function syncPresetsFromCatalog(){
  allPresets.forEach(p=>{
    const ids=p.tags||[]; let checked=0, known=0;
    ids.forEach(id=>{
      const box=checkboxMap.get(id);
      if (box){ known++; if (box.checked) checked++; }
      else if (extraSet.has(id)){ known++; checked++; }
    });
    const cb=presetBoxMap.get(p.id); if(!cb) return;
    if (checked===0){ cb.checked=false; cb.indeterminate=false; }
    else if (checked===known && known>0){ cb.checked=true; cb.indeterminate=false; }
    else { cb.checked=false; cb.indeterminate=true; }
  });
}
function generateTags(){
  const ids=[];
  checkboxMap.forEach((cb,id)=>{ if (cb.checked) ids.push(id); });
  extraBody?.querySelectorAll('input[type=checkbox]:checked').forEach(cb=>{
    const id=cb.dataset.id||cb.value||''; if(id) ids.push(id);
  });
  out.value = ids.filter(Boolean).join(', ');
}
function resetAll(){
  checkboxMap.forEach(cb=> cb.checked=false);
  presetBoxMap.forEach(cb=> { cb.checked=false; cb.indeterminate=false; });
  extraSet.clear(); extraBody.innerHTML=''; extraCount.textContent='0'; out.value='';
}
document.getElementById('btnGen').addEventListener('click', generateTags);
document.getElementById('btnReset').addEventListener('click', resetAll);
document.getElementById('btnCopy').addEventListener('click', ()=> navigator.clipboard.writeText(out.value));

/* ===== åˆæœŸåŒ–ï¼ˆUIã¯åˆæœŸã‚¯ãƒ­ãƒ¼ã‚ºç¶­æŒï¼‰ ===== */
(async function init(){
  loadLog.textContent = '';
  await loadPartsSeq(1,200);   // mix
  await loadPoseSeq(1,200);    // pose
  await loadHairSeq(1,200);    // hair
  integrateMix();
  integratePose();
  integrateHair();
  buildPresets();
  buildExpressionsByMood();
  buildEffects();
  buildPoses();
  buildHair();
  document.querySelectorAll('details').forEach(d=> d.open=false);
})();
</script>
</body>
</html>