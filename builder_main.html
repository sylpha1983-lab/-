<!-- builder_main.html v6.4 (2025-09-05)
  - 安定逐次ローダー（mix→pose→hair）＋リトライ＆<script src>フォールバック
  - 旧形式データ（expressions/effects/presets）取り込み互換
  - 背景：場所を1つに統合しサブカテゴリ（店/家/町/森林/水辺/道路/学校/病院…）で自動分割
  - 由来ファイル表示 (partXX.js / pose_partYY.js / hair_partZZ.js)
  - 既存UI・仕様は不変（読み込みチェッカー／初期クローズ／出力は英語idカンマ区切り）
-->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>表情＋エフェクト複合ビルダー（安定版）</title>
<style>
  :root{--pad:10px}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111;margin:10px}
  h1{font-size:1.12rem;margin:6px 0 12px}
  .card{padding:var(--pad);border:1px solid #eee;border-radius:12px;background:#fff;margin:10px 0}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0;flex-wrap:wrap}
  input[type="search"]{width:100%;padding:.7em;border:1px solid #ccc;border-radius:10px}
  .btn{padding:.65em 1em;border:1px solid #ccc;border-radius:10px;background:#f8f8f8}
  .btn:active{transform:translateY(1px)}
  details{border:1px solid #eee;border-radius:12px;padding:6px;margin:8px 0;background:#fff}
  summary{cursor:pointer;font-weight:700;list-style:none}
  summary::-webkit-details-marker{display:none}
  label.item{display:flex;align-items:center;gap:8px;padding:6px 2px;line-height:1.25}
  .muted{color:#666}
  textarea{width:100%;min-height:140px;padding:10px;border:1px solid #ccc;border-radius:12px}
  .pill{font-size:.8rem;border:1px solid #ddd;border-radius:999px;padding:.15em .55em;background:#fafafa}
  .count{font-variant-numeric:tabular-nums}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;font-size:.9rem;white-space:pre-wrap}
  .ok{color:#067}.ng{color:#b00}.empty{color:#666}
  .progressbar{width:100%;height:12px;background:#eee;border-radius:6px;overflow:hidden;margin-top:6px}
  .progress-inner{height:100%;display:flex}
  .seg-ok{background:#4CAF50;transition:width .15s}
  .seg-ng{background:#E53935;transition:width .15s}
  .seg-empty{background:#9E9E9E;transition:width .15s}
  .seg-rest{background:transparent;flex:1}
</style>
</head>
<body>
  <h1>表情＋エフェクト複合ビルダー（喜怒哀楽・初期クローズ／ポーズ・髪型対応）</h1>

  <!-- 読み込みチェッカー（固定仕様） -->
  <div class="card">
    <details id="checkerBox">
      <summary>
        読み込みチェッカー：
        <span id="loadSummary" class="pill count">mix: 成功0/失敗0/空0 ｜ pose: 成功0/失敗0/空0 ｜ hair: 成功0/失敗0/空0</span>
      </summary>
      <div class="progressbar"><div class="progress-inner">
        <div id="barOk" class="seg-ok" style="width:0%"></div>
        <div id="barNg" class="seg-ng" style="width:0%"></div>
        <div id="barEmpty" class="seg-empty" style="width:0%"></div>
        <div id="barRest" class="seg-rest"></div>
      </div></div>
      <div id="loadLog" class="mono muted"></div>
    </details>
  </div>

  <!-- プリセット -->
  <div class="card">
    <input id="presetSearch" type="search" placeholder="プリセット検索 / Preset search (JP/EN)">
    <details id="presetsBox">
      <summary>プリセット（✨ 喜 / 💢 怒 / 😢 哀 / 🎵 楽 / ❤️ heart・初期閉） <span id="presetCount" class="pill count"></span></summary>
      <details><summary>✨ 喜 <span id="pcJoy" class="pill count"></span></summary><div id="presetJoy"></div></details>
      <details><summary>💢 怒 <span id="pcAnger" class="pill count"></span></summary><div id="presetAnger"></div></details>
      <details><summary>😢 哀 <span id="pcSad" class="pill count"></span></summary><div id="presetSad"></div></details>
      <details><summary>🎵 楽 <span id="pcFun" class="pill count"></span></summary><div id="presetFun"></div></details>
      <details><summary>❤️ heart <span id="pcHeart" class="pill count"></span></summary><div id="presetHeart"></div></details>
      <details><summary>その他 <span id="pcOther" class="pill count"></span></summary><div id="presetOther"></div></details>
    </details>
  </div>

  <!-- 表情 -->
  <div class="card">
    <input id="exprSearch" type="search" placeholder="表情検索 / Expression search (JP/EN)">
    <details id="exprBox">
      <summary>表情（✨ 喜 / 💢 怒 / 😢 哀 / 🎵 楽 / ❤️ heart・初期閉） <span id="exprCount" class="pill count"></span></summary>
      <details><summary>✨ 喜 <span id="ecJoy" class="pill count"></span></summary><div id="exprJoy"></div></details>
      <details><summary>💢 怒 <span id="ecAnger" class="pill count"></span></summary><div id="exprAnger"></div></details>
      <details><summary>😢 哀 <span id="ecSad" class="pill count"></span></summary><div id="exprSad"></div></details>
      <details><summary>🎵 楽 <span id="ecFun" class="pill count"></span></summary><div id="exprFun"></div></details>
      <details><summary>❤️ heart <span id="ecHeart" class="pill count"></span></summary><div id="exprHeart"></div></details>
    </details>
  </div>

  <!-- 背景（=エフェクト統合：場所／構図・フレーミング／エフェクト系） -->
  <div class="card">
    <input id="effSearch" type="search" placeholder="背景検索 / Background search (JP/EN)">
    <details id="effBox">
      <summary>背景（場所／構図・フレーミング／エフェクト系・初期閉） <span id="effCount" class="pill count"></span></summary>
      <div id="catalogEff"></div>
    </details>
  </div>

  <!-- ポーズ -->
  <div class="card">
    <input id="poseSearch" type="search" placeholder="ポーズ検索 / Pose search (JP/EN)">
    <details id="poseBox">
      <summary>ポーズ（カテゴリ別・初期閉） <span id="poseCount" class="pill count"></span></summary>
      <div id="catalogPose"></div>
    </details>
  </div>

  <!-- 髪型 -->
  <div class="card">
    <input id="hairSearch" type="search" placeholder="髪型検索 / Hair search (JP/EN)">
    <details id="hairBox">
      <summary>髪型（カテゴリ別・初期閉） <span id="hairCount" class="pill count"></span></summary>
      <div id="catalogHair"></div>
    </details>
  </div>

  <!-- Extra -->
  <div class="card">
    <details id="extraBox">
      <summary>Extra（カタログ外 / Not in catalog・初期閉） <span id="extraCount" class="pill count">0</span></summary>
      <div id="extraBody"></div>
    </details>
  </div>

  <!-- 出力 -->
  <div class="card">
    <div class="row">
      <button id="btnGen" class="btn">タグ生成</button>
      <button id="btnReset" class="btn">リセット（Extra含む）</button>
      <button id="btnCopy" class="btn">コピー</button>
      <small class="muted">出力は英語タグ（id）をカンマ区切り。UIは日英併記。</small>
    </div>
    <textarea id="out" placeholder="generated tags will appear here..."></textarea>
  </div>

<script>
/* ================= レジストリ（互換＋別名対応） ================= */
window.__registerPromptPart=function(id,data){var pb=(window.promptBuilder=window.promptBuilder||{});pb[id]=data;var a=window.__CURRENT_LOAD_NAME;if(a&&!pb[a])pb[a]=data;};
window.registerPromptPart=window.__registerPromptPart; window.__registerPromptPack=window.__registerPromptPart;
window.__registerPosePart=function(id,data){var p=(window.poseBuilder=window.poseBuilder||{});p[id]=data;var a=window.__CURRENT_LOAD_NAME;if(a&&!p[a])p[a]=data;};
window.__registerHairPart=function(id,data){var h=(window.hairBuilder=window.hairBuilder||{});h[id]=data;var a=window.__CURRENT_LOAD_NAME;if(a&&!h[a])h[a]=data;};

/* ================= 参照・状態 ================= */
var loadSummary=document.getElementById('loadSummary');
var loadLog=document.getElementById('loadLog');
var barOk=document.getElementById('barOk'), barNg=document.getElementById('barNg'), barEmpty=document.getElementById('barEmpty'), barRest=document.getElementById('barRest');

var presetCountEl=document.getElementById('presetCount'), exprCountEl=document.getElementById('exprCount'), effCountEl=document.getElementById('effCount'), poseCountEl=document.getElementById('poseCount'), hairCountEl=document.getElementById('hairCount');
var presetAreas={joy:document.getElementById('presetJoy'),anger:document.getElementById('presetAnger'),sad:document.getElementById('presetSad'),fun:document.getElementById('presetFun'),heart:document.getElementById('presetHeart'),other:document.getElementById('presetOther')};
var presetAreaCounts={joy:document.getElementById('pcJoy'),anger:document.getElementById('pcAnger'),sad:document.getElementById('pcSad'),fun:document.getElementById('pcFun'),heart:document.getElementById('pcHeart'),other:document.getElementById('pcOther')};
var exprAreas={joy:document.getElementById('exprJoy'),anger:document.getElementById('exprAnger'),sad:document.getElementById('exprSad'),fun:document.getElementById('exprFun'),heart:document.getElementById('exprHeart')};
var exprAreaCounts={joy:document.getElementById('ecJoy'),anger:document.getElementById('ecAnger'),sad:document.getElementById('ecSad'),fun:document.getElementById('ecFun'),heart:document.getElementById('ecHeart')};
var catalogEffRoot=document.getElementById('catalogEff'), catalogPoseRoot=document.getElementById('catalogPose'), catalogHairRoot=document.getElementById('catalogHair');
var extraBody=document.getElementById('extraBody'), extraCount=document.getElementById('extraCount'), out=document.getElementById('out');

var checkboxMap=new Map(); var presetBoxMap=new Map(); var extraSet=new Set(); var tagSourceMap=new Map();

var allCategories=[], allPresets=[], allPoseCategories=[], allHairCategories=[], injectedEffectCats=[];

/* ================= ログ／チェッカー ================= */
function log(t,cls){var d=document.createElement('div'); d.textContent=t; if(cls)d.className=cls; loadLog.appendChild(d);}
function toInt(v){v=+v; return isFinite(v)?v:0;}
function updateLoadSummary(){
  var mOk=toInt(loadSummary.dataset.mixOk), mNg=toInt(loadSummary.dataset.mixNg), mEm=toInt(loadSummary.dataset.mixEmpty);
  var pOk=toInt(loadSummary.dataset.poseOk), pNg=toInt(loadSummary.dataset.poseNg), pEm=toInt(loadSummary.dataset.poseEmpty);
  var hOk=toInt(loadSummary.dataset.hairOk), hNg=toInt(loadSummary.dataset.hairNg), hEm=toInt(loadSummary.dataset.hairEmpty);
  loadSummary.textContent='mix: 成功'+mOk+'/失敗'+mNg+'/空'+mEm+' ｜ '+
                          'pose: 成功'+pOk+'/失敗'+pNg+'/空'+pEm+' ｜ '+
                          'hair: 成功'+hOk+'/失敗'+hNg+'/空'+hEm;
  var TOTAL=200*3; var ok=mOk+pOk+hOk, ng=mNg+pNg+hNg, em=mEm+pEm+hEm;
  var okp=TOTAL?ok/TOTAL*100:0, ngp=TOTAL?ng/TOTAL*100:0, emp=TOTAL?em/TOTAL*100:0;
  barOk.style.width=okp.toFixed(2)+'%'; barNg.style.width=ngp.toFixed(2)+'%'; barEmpty.style.width=emp.toFixed(2)+'%'; barRest.style.width=Math.max(0,100-okp-ngp-emp).toFixed(2)+'%';
}
Object.assign(loadSummary.dataset,{mixOk:0,mixNg:0,mixEmpty:0,poseOk:0,poseNg:0,poseEmpty:0,hairOk:0,hairNg:0,hairEmpty:0});
updateLoadSummary();

/* ================= 旧→新 変換等 ================= */
function convertOldExpressionEffectsToNew(obj){
  var categories=[];
  if(obj && obj.expressions && obj.expressions.length){
    categories.push({name:'Expressions / 表情',items:obj.expressions.map(function(e){return {id:e.id,label:(e.jp||e.label||e.id)+' / '+e.id};})});
  }
  if(obj && obj.effects && obj.effects.length){
    var groups={};
    obj.effects.forEach(function(e){
      var key=e.category||'Effects / エフェクト';
      (groups[key]||(groups[key]=[])).push({id:e.id,label:(e.jp||e.label||e.id)+' / '+e.id});
    });
    Object.keys(groups).forEach(function(k){ categories.push({name:k,items:groups[k]}); });
  }
  var presets=[];
  if(obj && obj.presets && obj.presets.length){
    presets=obj.presets.map(function(p){
      var tags=[].concat(p.tags||[], p.expressions||[], p.effects||[]);
      var uniq=[]; tags.forEach(function(t){ if(uniq.indexOf(t)<0) uniq.push(t); });
      return {id:p.id,label:p.label||p.id,tags:uniq};
    });
  }
  return {categories:categories,presets:presets};
}
function normalizeGenericPart(data){
  if(!data) return null;
  if(data.categories && data.categories.length){
    data.categories.forEach(function(c){
      c.items=(c.items||[]).map(function(it){return {id:it.id,label:it.label||it.id};});
    });
    return data;
  }
  if(data.name && data.items && data.items.length){
    return {categories:[{name:data.name,items:data.items.map(function(it){return {id:it.id,label:it.label||it.id};})}]};
  }
  return null;
}
function recordSources(categories,fileLabel){
  (categories||[]).forEach(function(c){
    (c.items||[]).forEach(function(it){
      if(it && it.id && !tagSourceMap.has(it.id)) tagSourceMap.set(it.id,fileLabel);
    });
  });
}

/* ================= ensure ================= */
function ensureRegisteredMix(name){
  var fileLabel=name+'.js'; var pb=(window.promptBuilder=window.promptBuilder||{}); var d=pb[name];
  if(!d && window.expressionEffects && window.expressionEffects[name]){ d=convertOldExpressionEffectsToNew(window.expressionEffects[name]); pb[name]=d; }
  if(!d && window[name]){ var maybe=window[name]; d=maybe.categories?maybe:convertOldExpressionEffectsToNew(maybe); pb[name]=d; }
  if(!d) return false;
  recordSources(d.categories,fileLabel);
  (d.presets||[]).forEach(function(pr){ if(!allPresets.some(function(x){return x.id===pr.id;})) allPresets.push({id:pr.id,label:pr.label,tags:pr.tags||[]}); });
  return true;
}
function ensureRegisteredPose(id){
  var fileLabel=id+'.js'; var p=(window.poseBuilder=window.poseBuilder||{}); var d=p[id];
  if(!d && window[id]){ d=normalizeGenericPart(window[id]); if(d) p[id]=d; }
  if(!d && window.poseParts && window.poseParts[id]){ d=normalizeGenericPart(window.poseParts[id]); if(d) p[id]=d; }
  if(!d) return false; recordSources(d.categories,fileLabel); return true;
}
function ensureRegisteredHair(id){
  var fileLabel=id+'.js'; var h=(window.hairBuilder=window.hairBuilder||{}); var d=h[id];
  if(!d && window[id]){ d=normalizeGenericPart(window[id]); if(d) h[id]=d; }
  if(!d && window.hairParts && window.hairParts[id]){ d=normalizeGenericPart(window.hairParts[id]); if(d) h[id]=d; }
  if(!d) return false; recordSources(d.categories,fileLabel); return true;
}

/* ================= ローダー共通：リトライ＋<script src>フォールバック ================= */
function sleep(ms){ return new Promise(function(r){setTimeout(r,ms);}); }
function appendInlineScript(js, url, currentName){
  var s=document.createElement('script');
  window.__CURRENT_LOAD_NAME=currentName;
  s.textContent=js+'\n//# sourceURL='+url;
  document.head.appendChild(s);
  window.__CURRENT_LOAD_NAME=null;
}
function loadScriptViaSrc(url){
  return new Promise(function(resolve,reject){
    var s=document.createElement('script');
    s.src=url+'?v='+Date.now();
    s.onload=function(){resolve(true);};
    s.onerror=function(){reject(new Error('script onerror'));};
    document.head.appendChild(s);
  });
}
async function robustLoad(url,currentName){
  try{
    var res=await fetch(url,{cache:'no-store'});
    if(res.status===404) return {kind:'empty',msg:'404'};
    if(!res.ok) throw new Error('HTTP '+res.status);
    var js=await res.text();
    appendInlineScript(js,url,currentName);
    return {kind:'ok'};
  }catch(e1){
    try{
      await sleep(180);
      var res2=await fetch(url,{cache:'no-store'});
      if(res2.status===404) return {kind:'empty',msg:'404'};
      if(!res2.ok) throw new Error('HTTP '+res2.status);
      var js2=await res2.text();
      appendInlineScript(js2,url,currentName);
      return {kind:'ok'};
    }catch(e2){
      try{
        await loadScriptViaSrc(url); // Fallback
        return {kind:'ok',msg:'fallback'};
      }catch(e3){
        return {kind:'fail',msg:(e1&&e1.message)||'fetch-fail'};
      }
    }
  }
}

/* ================= 逐次ローダー ================= */
async function loadPartsSeq(from,to){
  window.promptBuilder=window.promptBuilder||{};
  var ok=0,ng=0,empty=0;
  for(var i=from;i<=to;i++){
    var name='part'+i, url=name+'.js';
    var r=await robustLoad(url,name);
    if(r.kind==='ok'){
      if(ensureRegisteredMix(name)){ ok++; log(name+': OK','ok'); }
      else { empty++; log(name+': EMPTY（未登録）','empty'); }
    }else if(r.kind==='empty'){ empty++; log(name+': EMPTY（未配置）','empty'); }
    else{ ng++; log(name+': ERROR '+r.msg,'ng'); }
    loadSummary.dataset.mixOk=ok; loadSummary.dataset.mixNg=ng; loadSummary.dataset.mixEmpty=empty; updateLoadSummary();
  }
}
async function loadPoseSeq(from,to){
  window.poseBuilder=window.poseBuilder||{};
  var ok=0,ng=0,empty=0;
  for(var i=from;i<=to;i++){
    var id='pose_part'+i, url=id+'.js';
    var r=await robustLoad(url,id);
    if(r.kind==='ok'){
      if(ensureRegisteredPose(id)){ ok++; log(id+': OK','ok'); }
      else { empty++; log(id+': EMPTY（未登録）','empty'); }
    }else if(r.kind==='empty'){ empty++; log(id+': EMPTY（未配置）','empty'); }
    else{ ng++; log(id+': ERROR '+r.msg,'ng'); }
    loadSummary.dataset.poseOk=ok; loadSummary.dataset.poseNg=ng; loadSummary.dataset.poseEmpty=empty; updateLoadSummary();
  }
}
async function loadHairSeq(from,to){
  window.hairBuilder=window.hairBuilder||{};
  var ok=0,ng=0,empty=0;
  for(var i=from;i<=to;i++){
    var id='hair_part'+i, url=id+'.js';
    var r=await robustLoad(url,id);
    if(r.kind==='ok'){
      if(ensureRegisteredHair(id)){ ok++; log(id+': OK','ok'); }
      else { empty++; log(id+': EMPTY（未登録）','empty'); }
    }else if(r.kind==='empty'){ empty++; log(id+': EMPTY（未配置）','empty'); }
    else{ ng++; log(id+': ERROR '+r.msg,'ng'); }
    loadSummary.dataset.hairOk=ok; loadSummary.dataset.hairNg=ng; loadSummary.dataset.hairEmpty=empty; updateLoadSummary();
  }
}

/* ================= 統合（mix/pose/hair） ================= */
function isPlaceCategoryName(name){var n=(name||'').toLowerCase(); return /背景|場所|background|location|place|scene|scenery/.test(n);}
function isCompositionCategoryName(name){var n=(name||'').toLowerCase(); return /構図|ﾌﾚｰﾐﾝｸﾞ|フレーミング|composition|framing|rule[- ]?of[- ]?thirds|golden/.test(n);}

function integrateMix(){
  var parts=window.promptBuilder||{}; var catMap=new Map();
  Object.keys(parts).sort().forEach(function(k){
    var p=parts[k]||{};
    (p.categories||[]).forEach(function(cat){
      if(!cat||!cat.name) return;
      if(!catMap.has(cat.name)) catMap.set(cat.name,{name:cat.name,items:[]});
      var b=catMap.get(cat.name);
      (cat.items||[]).forEach(function(it){ if(it&&it.id && !b.items.some(function(x){return x.id===it.id;})) b.items.push({id:it.id,label:it.label||it.id}); });
    });
    (p.presets||[]).forEach(function(pr){ if(!allPresets.some(function(x){return x.id===pr.id;})) allPresets.push({id:pr.id,label:pr.label,tags:pr.tags||[]}); });
  });
  allCategories=Array.from(catMap.values()).sort(function(a,b){return a.name.localeCompare(b.name,'ja');});
}
function integratePose(){
  injectedEffectCats=[]; var parts=window.poseBuilder||{}; var catMap=new Map();
  Object.keys(parts).sort().forEach(function(k){
    var d=parts[k]; var cats=(d&&d.categories)?d.categories:[];
    cats.forEach(function(cat){
      if(!cat||!cat.name) return;
      if(isPlaceCategoryName(cat.name)){
        var clone={name:cat.name,items:[]};
        (cat.items||[]).forEach(function(it){ if(it&&it.id && !clone.items.some(function(x){return x.id===it.id;})) clone.items.push({id:it.id,label:it.label||it.id}); });
        injectedEffectCats.push(clone);
      }
      if(!catMap.has(cat.name)) catMap.set(cat.name,{name:cat.name,items:[]});
      var b=catMap.get(cat.name);
      (cat.items||[]).forEach(function(it){ if(it&&it.id && !b.items.some(function(x){return x.id===it.id;})) b.items.push({id:it.id,label:it.label||it.id}); });
    });
  });
  allPoseCategories=Array.from(catMap.values()).sort(function(a,b){return a.name.localeCompare(b.name,'ja');});
}
function integrateHair(){
  var parts=window.hairBuilder||{}; var catMap=new Map();
  Object.keys(parts).sort().forEach(function(k){
    var d=parts[k]; var cats=(d&&d.categories)?d.categories:[];
    cats.forEach(function(cat){
      if(!cat||!cat.name) return;
      if(!catMap.has(cat.name)) catMap.set(cat.name,{name:cat.name,items:[]});
      var b=catMap.get(cat.name);
      (cat.items||[]).forEach(function(it){ if(it&&it.id && !b.items.some(function(x){return x.id===it.id;})) b.items.push({id:it.id,label:it.label||it.id}); });
    });
  });
  allHairCategories=Array.from(catMap.values()).sort(function(a,b){return a.name.localeCompare(b.name,'ja');});
}

/* ================= ビルド（UI描画） ================= */
function labelWithSource(base,id){var src=tagSourceMap.get(id); return (base||id)+' / '+id+(src?(' ('+src+')'):'');}

function buildPresets(){
  Object.keys(presetAreas).forEach(function(k){var el=presetAreas[k]; if(el) el.innerHTML='';});
  var counts={joy:0,anger:0,sad:0,fun:0,heart:0,other:0};
  var lex={joy:/喜|嬉|smile|happy/i, anger:/怒|angry|rage|glare|ジト/i, sad:/哀|寂|涙|tired|sleepy|sad/i, fun:/楽|wink|play|surpris/i, heart:/heart|love|♥|❤|kiss|抱/i};
  allPresets.forEach(function(pr){
    var bucket='fun', t=pr.label||'';
    if(lex.heart.test(t)) bucket='heart'; else if(lex.joy.test(t)) bucket='joy'; else if(lex.anger.test(t)) bucket='anger'; else if(lex.sad.test(t)) bucket='sad';
    var area=presetAreas[bucket]||presetAreas.other;
    var lab=document.createElement('label'); lab.className='item';
    var cb=document.createElement('input'); cb.type='checkbox'; cb.value=pr.id; cb.dataset.preset='1';
    checkboxMap.set(cb,pr.id); presetBoxMap.set(pr.id,pr.tags||[]);
    lab.appendChild(cb); lab.appendChild(document.createTextNode(pr.label));
    area.appendChild(lab); counts[bucket]=(counts[bucket]||0)+1;
  });
  presetCountEl.textContent='全'+allPresets.length;
  presetAreaCounts.joy.textContent=counts.joy||0; presetAreaCounts.anger.textContent=counts.anger||0; presetAreaCounts.sad.textContent=counts.sad||0; presetAreaCounts.fun.textContent=counts.fun||0; presetAreaCounts.heart.textContent=counts.heart||0; presetAreaCounts.other.textContent=counts.other||0;
}

function buildExpressionsByMood(){
  Object.keys(exprAreas).forEach(function(k){var el=exprAreas[k]; if(el) el.innerHTML='';});
  var exprCat=null; for(var i=0;i<allCategories.length;i++){ if((allCategories[i].name||'').indexOf('Expressions')===0){ exprCat=allCategories[i]; break; } }
  var items=(exprCat&&exprCat.items)||[];
  var counts={joy:0,anger:0,sad:0,fun:0,heart:0};
  var lex={joy:/喜|嬉|smile|happy/i, anger:/怒|angry|rage|glare|ジト/i, sad:/哀|寂|涙|tired|sleepy|sad/i, fun:/楽|wink|play|surpris/i, heart:/heart|love|♥|❤|kiss|抱/i};
  items.forEach(function(it){
    var bucket='fun', t=it.label||it.id;
    if(lex.heart.test(t)) bucket='heart'; else if(lex.joy.test(t)) bucket='joy'; else if(lex.anger.test(t)) bucket='anger'; else if(lex.sad.test(t)) bucket='sad';
    var lab=document.createElement('label'); lab.className='item';
    var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; checkboxMap.set(cb,it.id);
    lab.appendChild(cb); lab.appendChild(document.createTextNode(labelWithSource(it.label,it.id)));
    (exprAreas[bucket]||exprAreas.fun).appendChild(lab); counts[bucket]++;
  });
  exprCountEl.textContent='全'+items.length;
  exprAreaCounts.joy.textContent=counts.joy||0; exprAreaCounts.anger.textContent=counts.anger||0; exprAreaCounts.sad.textContent=counts.sad||0; exprAreaCounts.fun.textContent=counts.fun||0; exprAreaCounts.heart.textContent=counts.heart||0;
}

/* ======== 背景：場所を統合してサブカテゴリで分割（店/家/町/森林…） ======== */
function buildEffects(){
  catalogEffRoot.innerHTML = '';

  var effectCats = allCategories.filter(function(c){return (c.name||'').indexOf('Expressions')!==0;}).concat(injectedEffectCats);
  var placeCats = effectCats.filter(function(c){return isPlaceCategoryName(c.name);});
  var compCats  = effectCats.filter(function(c){return !isPlaceCategoryName(c.name) && isCompositionCategoryName(c.name);});
  var otherCats = effectCats.filter(function(c){return !isPlaceCategoryName(c.name) && !isCompositionCategoryName(c.name);});

  // 場所アイテムを統合
  var placeItems = [];
  placeCats.forEach(function(cat){
    (cat.items||[]).forEach(function(it){
      if(it && it.id && !placeItems.some(function(x){return x.id===it.id;})){
        placeItems.push({id:it.id,label:it.label||it.id});
      }
    });
  });

  // サブカテゴリ定義
  var groups = [
    { key:'city',   title:'町・都市 / City & Town',   kws:['city','street','downtown','urban','alley','plaza','square','market','bazaar','城下','商店街','路地','広場'] },
    { key:'store',  title:'店・飲食 / Shops & Food',  kws:['shop','store','cafe','bar','restaurant','diner','bakery','izakaya','coffee','喫茶','居酒屋','レストラン','食堂','パン屋','market'] },
    { key:'house',  title:'家・住宅 / House',        kws:['house','home','room','living','kitchen','bedroom','bathroom','toilet','apartment','mansion','和室','居間','台所','寝室','浴室','トイレ','部屋'] },
    { key:'school', title:'学校 / School',            kws:['school','class','classroom','campus','library','lab','体育館','教室','図書館','理科室'] },
    { key:'hospital',title:'病院 / Hospital',         kws:['hospital','clinic','ward','operating','er','検査','手術','病室','病院'] },
    { key:'office', title:'オフィス / Office',        kws:['office','meeting','conference','desk','work','cowork','会議','執務','デスク','オフィス'] },
    { key:'transport',title:'交通 / Transport',       kws:['station','train','subway','bus','airport','harbor','port','platform','runway','rail','停留所','駅','港','空港'] },
    { key:'road',   title:'道路・橋 / Roads & Bridge',kws:['road','street','highway','bridge','crosswalk','tunnel','intersection','道路','橋','横断歩道','トンネル','交差点'] },
    { key:'nature', title:'自然 / Nature',            kws:['nature','outdoor','field','meadow','valley','cliff','岩','谷','原っぱ','野原'] },
    { key:'forest', title:'森林 / Forest',            kws:['forest','woods','jungle','grove','林','森','樹木'] },
    { key:'water',  title:'水辺 / Water',             kws:['river','lake','sea','ocean','beach','shore','waterfall','pond','港','砂浜','海','湖','川','滝'] },
    { key:'mount',  title:'山・砂漠 / Mountain & Desert', kws:['mountain','hill','desert','dune','snow','alps','峰','山','雪','砂漠'] },
    { key:'park',   title:'公園・庭園 / Park & Garden', kws:['park','garden','shrine','temple','torii','yard','庭','公園','神社','寺','鳥居'] },
    { key:'industrial',title:'工業・倉庫 / Industrial',kws:['factory','plant','warehouse','hangar','workshop','工場','倉庫','作業場'] },
    { key:'fantasy',title:'SF/ファンタジー / Fantasy & SF',kws:['castle','palace','space','sci-fi','laboratory','magical','arena','王宮','宇宙','魔法','城','闘技場','研究所'] },
    { key:'sports', title:'スポーツ / Sports',        kws:['stadium','gym','court','ring','field','pitch','競技場','体育','コート','リング'] },
    { key:'shrine', title:'和風・社寺 / Japanese Shrine',kws:['shrine','temple','torii','社','寺','神社','鳥居'] },
    { key:'other',  title:'その他 / Others',           kws:[] }
  ];
  function chooseGroup(text){
    var s=(text||'').toLowerCase();
    for(var i=0;i<groups.length-1;i++){
      var g=groups[i];
      for(var j=0;j<g.kws.length;j++){ if(s.indexOf(g.kws[j])>=0) return g.key; }
    }
    return 'other';
  }
  var grouped={}; groups.forEach(function(g){ grouped[g.key]=[]; });
  placeItems.forEach(function(it){
    var base=(it.label||it.id);
    var key=chooseGroup(base+' '+it.id);
    if(!grouped[key].some(function(x){return x.id===it.id;})) grouped[key].push(it);
  });

  // 汎用追加関数
  var append=function(wrap,cats){
    cats.forEach(function(cat){
      var d=document.createElement('details'); d.open=false;
      var s=document.createElement('summary'); s.textContent=cat.name+' ('+((cat.items&&cat.items.length)||0)+')'; d.appendChild(s);
      (cat.items||[]).forEach(function(it){
        var lab=document.createElement('label'); lab.className='item';
        var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; checkboxMap.set(cb,it.id);
        lab.appendChild(cb); lab.appendChild(document.createTextNode(labelWithSource(it.label,it.id)));
        d.appendChild(lab);
      });
      wrap.appendChild(d);
    });
  };

  // 場所（大項目）＋サブカテゴリ
  var placeWrap=document.createElement('details'); placeWrap.open=false;
  var totalPlace=placeItems.length;
  var placeSum=document.createElement('summary'); placeSum.textContent='場所 / Place ('+totalPlace+')';
  placeWrap.appendChild(placeSum);
  groups.forEach(function(g){
    var items=grouped[g.key]; if(!items||!items.length) return;
    var dd=document.createElement('details'); dd.open=false;
    var sm=document.createElement('summary'); sm.textContent=g.title+' ('+items.length+')';
    dd.appendChild(sm);
    items.forEach(function(it){
      var lab=document.createElement('label'); lab.className='item';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; checkboxMap.set(cb,it.id);
      lab.appendChild(cb); lab.appendChild(document.createTextNode(labelWithSource(it.label,it.id)));
      dd.appendChild(lab);
    });
    placeWrap.appendChild(dd);
  });

  // 構図・フレーミング
  var compWrap=document.createElement('details'); compWrap.open=false;
  var compSum=document.createElement('summary');
  var totalComp=compCats.reduce(function(a,c){return a+((c.items&&c.items.length)||0);},0);
  compSum.textContent='構図・フレーミング / Composition & Framing ('+totalComp+')';
  compWrap.appendChild(compSum);
  append(compWrap,compCats);

  // エフェクト系（その他）
  var fxWrap=document.createElement('details'); fxWrap.open=false;
  var fxSum=document.createElement('summary');
  var totalFx=otherCats.reduce(function(a,c){return a+((c.items&&c.items.length)||0);},0);
  fxSum.textContent='エフェクト系 / Effects ('+totalFx+')';
  fxWrap.appendChild(fxSum);
  append(fxWrap,otherCats);

  catalogEffRoot.appendChild(placeWrap);
  catalogEffRoot.appendChild(compWrap);
  catalogEffRoot.appendChild(fxWrap);

  var totalAll = totalPlace + totalComp + totalFx;
  effCountEl.textContent='全'+totalAll;
}

function buildPoses(){
  catalogPoseRoot.innerHTML='';
  allPoseCategories.forEach(function(cat){
    var d=document.createElement('details'); d.open=false;
    var s=document.createElement('summary'); s.textContent=cat.name+' ('+(cat.items?cat.items.length:0)+')'; d.appendChild(s);
    (cat.items||[]).forEach(function(it){
      var lab=document.createElement('label'); lab.className='item';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; checkboxMap.set(cb,it.id);
      lab.appendChild(cb); lab.appendChild(document.createTextNode(labelWithSource(it.label,it.id)));
      d.appendChild(lab);
    });
    catalogPoseRoot.appendChild(d);
  });
  var total=allPoseCategories.reduce(function(a,c){return a+((c.items&&c.items.length)||0);},0);
  poseCountEl.textContent='全'+total;
}
function buildHair(){
  catalogHairRoot.innerHTML='';
  allHairCategories.forEach(function(cat){
    var d=document.createElement('details'); d.open=false;
    var s=document.createElement('summary'); s.textContent=cat.name+' ('+(cat.items?cat.items.length:0)+')'; d.appendChild(s);
    (cat.items||[]).forEach(function(it){
      var lab=document.createElement('label'); lab.className='item';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; checkboxMap.set(cb,cb.value);
      lab.appendChild(cb); lab.appendChild(document.createTextNode(labelWithSource(it.label,it.id)));
      d.appendChild(lab);
    });
    catalogHairRoot.appendChild(d);
  });
  var total=allHairCategories.reduce(function(a,c){return a+((c.items&&c.items.length)||0);},0);
  hairCountEl.textContent='全'+total;
}

/* ================= Extra／検索／出力 ================= */
function ensureExtraTag(id){ if(!id) return; if(!extraSet.has(id)){ extraSet.add(id);
  var lab=document.createElement('label'); lab.className='item';
  var cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.value=id; checkboxMap.set(cb,id);
  lab.appendChild(cb); lab.appendChild(document.createTextNode(labelWithSource(id,id)));
  extraBody.appendChild(lab); extraCount.textContent=String(extraSet.size);
}}
function attachSearch(){
  function bind(inputId,rootDetailsId,listRoot,itemSel){
    if(!itemSel) itemSel='label.item';
    var box=document.getElementById(rootDetailsId), input=document.getElementById(inputId); if(!input||!box) return;
    function run(){
      var q=(input.value||'').toLowerCase();
      Array.prototype.forEach.call(listRoot.querySelectorAll(':scope > details'),function(d){ d.open=false; });
      if(!q) return;
      Array.prototype.forEach.call(listRoot.querySelectorAll(':scope > details'),function(d){
        var sm=(d.querySelector(':scope > summary')?d.querySelector(':scope > summary').textContent:''); sm=(sm||'').toLowerCase();
        var hitSm=sm.indexOf(q)>=0;
        var hitIt=false;
        Array.prototype.forEach.call(d.querySelectorAll(itemSel),function(l){ if(!hitIt){ var t=(l.textContent||'').toLowerCase(); if(t.indexOf(q)>=0) hitIt=true; }});
        if(hitSm||hitIt) d.open=true;
        Array.prototype.forEach.call(d.querySelectorAll(':scope > details'),function(dd){
          var ssm=(dd.querySelector(':scope > summary')?dd.querySelector(':scope > summary').textContent:''); ssm=(ssm||'').toLowerCase();
          var sit=false; Array.prototype.forEach.call(dd.querySelectorAll(itemSel),function(l){ if(!sit){ var t=(l.textContent||'').toLowerCase(); if(t.indexOf(q)>=0) sit=true; }});
          if(ssm.indexOf(q)>=0||sit){ d.open=true; dd.open=true; }
        });
      });
      box.open=true;
    }
    input.addEventListener('input',run);
  }
  bind('presetSearch','presetsBox',document.getElementById('presetsBox'));
  bind('exprSearch','exprBox',document.getElementById('exprBox'));
  bind('effSearch','effBox',catalogEffRoot);
  bind('poseSearch','poseBox',catalogPoseRoot);
  bind('hairSearch','hairBox',catalogHairRoot);
}
function generateTags(){var tags=[]; checkboxMap.forEach(function(id,cb){ if(!cb.checked)return; if(cb.dataset.preset){ (presetBoxMap.get(id)||[]).forEach(function(t){tags.push(t);}); } else { tags.push(id); } }); extraSet.forEach(function(t){tags.push(t);}); var uniq=[]; tags.forEach(function(t){ if(uniq.indexOf(t)<0) uniq.push(t); }); out.value=uniq.join(', ');}
function resetAll(){ checkboxMap.forEach(function(id,cb){ cb.checked=false; }); extraSet.clear(); extraBody.innerHTML=''; extraCount.textContent='0'; out.value=''; }
function copyOut(){ out.select(); try{document.execCommand('copy');}catch(e){} }

/* ================= 起動（逐次ロード→統合→描画） ================= */
document.getElementById('btnGen').addEventListener('click',generateTags);
document.getElementById('btnReset').addEventListener('click',resetAll);
document.getElementById('btnCopy').addEventListener('click',copyOut);
Array.prototype.forEach.call(document.querySelectorAll('details'),function(d){ d.open=false; });

(async function(){
  try{
    // HTTPサーバから配信してください（file:// は fetch が失敗します）
    await loadPartsSeq(1,200); integrateMix();
    await loadPoseSeq(1,200);  integratePose();
    await loadHairSeq(1,200);  integrateHair();

    buildPresets();
    buildExpressionsByMood();
    buildEffects();   // 背景：場所（統合+サブ分類）／構図・フレーミング／エフェクト系
    buildPoses();
    buildHair();

    attachSearch();
    updateLoadSummary();
  }catch(e){
    log('INIT ERROR: '+e.message,'ng');
  }
})();
</script>
</body>
</html>
```0