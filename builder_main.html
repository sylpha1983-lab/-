<!-- builder_main.html v12.xï¼ˆEMPTYç¶™ç¶šï¼‹ãƒ¡ãƒƒã‚·ãƒ¥3æ®µUIï¼‹å ´æ‰€ãƒ„ãƒªãƒ¼å¾©å…ƒï¼‹ç™ºç«/é‡è¤‡FIXï¼‰ [1/2] -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è¡¨æƒ…ï¼‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‹èƒŒæ™¯ãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆãƒ©ã‚¤ãƒˆ UIãƒ»ã‚«ãƒ†ã‚´ãƒªç›´èª­ï¼‰</title>
<style>
  :root{
    --fg:#222; --muted:#667085; --ok:#16a34a; --bad:#dc2626; --empty:#2563eb; --bg:#fff; --chip:#f2f4f7;
    --line:#e5e7eb; --ink:#0b1220; --inkfg:#e6edf3;
  }
  html,body{margin:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif}
  .wrap{max-width:860px;margin:16px auto;padding:0 12px calc(120px + 32vh)}
  h1{font-size:22px;line-height:1.35;margin:10px 0 16px}
  .row{display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff}
  .badge{padding:6px 10px;border-radius:999px;font-size:12px;background:var(--chip)}
  .b-ok{color:#fff;background:var(--ok)}
  .b-bad{color:#fff;background:var(--bad)}
  .b-empty{color:#fff;background:var(--empty)}
  .readline{font-size:14px;color:#111}
  .meter-all{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden}
  .meter-fill{height:100%;width:0;background:linear-gradient(90deg,#93c5fd,#22c55e)}
  details{background:#fff;border:1px solid var(--line);border-radius:12px;margin:12px 0}
  summary{padding:14px 16px;cursor:pointer;list-style:none;font-weight:700}
  details[open]>summary{border-bottom:1px solid #eef0f2}
  .panel{padding:10px 14px}
  .log{
    background:#0b1220;color:#e6edf3;border-radius:12px;padding:14px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    white-space:pre-wrap;line-height:1.35;max-height:28vh;overflow:auto
  }
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .chk{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px}
  .foot{position:fixed;z-index:10;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);padding:10px}
  .foot .row{margin:0}
  .out{width:100%;min-height:110px;border:1px solid var(--line);border-radius:12px;padding:10px}
  .meterRow{display:flex;align-items:center;gap:10px;margin:8px 0}
  .meterBar{flex:1;height:6px;border-radius:999px;background:#eef2f7;position:relative;overflow:hidden}
  .meterFill{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#b5e3c3,#16a34a)}
  .slot{min-width:92px;text-align:right;color:#6b7280;font-size:12px}
  .subhead{font-size:14px;color:#334155;margin:6px 0 8px;font-weight:700}
  .toast{
    position:fixed;left:50%;bottom:96px;transform:translateX(-50%);
    background:#111827;color:#fff;padding:10px 14px;border-radius:10px;
    opacity:0;pointer-events:none;transition:opacity .25s ease;
    z-index:10000;font-size:14px;
  }
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>è¡¨æƒ…ï¼‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‹èƒŒæ™¯ãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆãƒ©ã‚¤ãƒˆ UIãƒ»ã‚«ãƒ†ã‚´ãƒªç›´èª­ï¼‰</h1>

  <div class="row">
    <button id="reloadBtn" class="btn">å†èª­è¾¼</button>
    <span class="badge b-ok" id="cntOK">æˆåŠŸ 0</span>
    <span class="badge b-bad" id="cntNG">å¤±æ•— 0</span>
    <span class="badge b-empty" id="cntEMPTY">ç©º 1200</span>
  </div>

  <div class="row" style="align-items:center">
    <span class="readline">èª­ã¿è¾¼ã¿: <span id="totalRead">0</span> / <span id="totalMax">1200</span></span>
    <div class="meter-all" style="flex:1;min-width:200px"><div id="overallFill" class="meter-fill"></div></div>
  </div>

  <details id="d-meters">
    <summary>â–¼ å„ã‚«ãƒ†ã‚´ãƒªã®é€²è¡Œãƒ»ãƒ­ã‚°ï¼ˆæˆåŠŸ/å¤±æ•—/ç©ºï¼‹ãƒ­ã‚°ï¼‰</summary>
    <div class="panel">
      <div id="meters"></div>
      <div class="subhead">èª­ã¿è¾¼ã¿ãƒ­ã‚°</div>
      <div id="log" class="log">(ãƒ­ã‚°ã¯ã“ã“ã«å‡ºã¾ã™)</div>
    </div>
  </details>

  <details id="d-presets"><summary>â–¼ ãƒ—ãƒªã‚»ãƒƒãƒˆ <span id="num-presets">0</span></summary>
    <div class="panel"><div id="list-presets" class="grid"></div></div>
  </details>

  <details id="d-expr"><summary>â–¼ è¡¨æƒ… <span id="num-expr">0</span></summary>
    <div class="panel">
      <details><summary>âœ¨ å–œ <span id="n-joy">0</span></summary><div class="panel"><div id="g-joy" class="grid"></div></div></details>
      <details><summary>ğŸ’¢ æ€’ <span id="n-anger">0</span></summary><div class="panel"><div id="g-anger" class="grid"></div></div></details>
      <details><summary>ğŸ˜¢ å“€ <span id="n-sad">0</span></summary><div class="panel"><div id="g-sad" class="grid"></div></div></details>
      <details><summary>ğŸµ æ¥½ <span id="n-happy">0</span></summary><div class="panel"><div id="g-happy" class="grid"></div></div></details>
      <details><summary>â¤ï¸ heart <span id="n-heart">0</span></summary><div class="panel"><div id="g-heart" class="grid"></div></div></details>

      <details><summary>ğŸ‘€ è¦–ç·šç³» <span id="n-eyes">0</span></summary><div class="panel"><div id="g-eyes" class="grid"></div></div></details>
      <details><summary>ğŸ’§ æ¶™ç³» <span id="n-tear">0</span></summary><div class="panel"><div id="g-tear" class="grid"></div></div></details>
      <details><summary>ğŸ‘„ å£å…ƒç³» <span id="n-mouth">0</span></summary><div class="panel"><div id="g-mouth" class="grid"></div></div></details>
      <details><summary>â“ å›°æƒ‘ <span id="n-confuse">0</span></summary><div class="panel"><div id="g-confuse" class="grid"></div></div></details>
      <details><summary>ğŸ˜³ ç·Šå¼µ <span id="n-tense">0</span></summary><div class="panel"><div id="g-tense" class="grid"></div></div></details>
      <details><summary>â˜ºï¸ æ¥ã˜ã‚‰ã„ <span id="n-shy">0</span></summary><div class="panel"><div id="g-shy" class="grid"></div></div></details>
      <details><summary>â–¶ ãã®ä»– <span id="n-etc">0</span></summary><div class="panel"><div id="g-etc" class="grid"></div></div></details>
    </div>
  </details>

  <details id="d-eff-subject"><summary>â–¼ è¢«å†™ä½“ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ <span id="num-eff-subject">0</span></summary>
    <div class="panel">
      <details><summary>âœ¨ ãƒªãƒ³ã‚°ãƒ»è¼ã <span id="n-eff-ring">0</span></summary><div class="panel"><div id="g-eff-ring" class="grid"></div></div></details>
      <details><summary>ğŸ§µ ãƒ©ã‚¤ãƒ³ï¼ã‚¹ãƒ”ãƒ¼ãƒ‰ç·š <span id="n-eff-line">0</span></summary><div class="panel"><div id="g-eff-line" class="grid"></div></div></details>
      <details><summary>ğŸŒ«ï¸ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ãƒ»ç²‰å¡µ <span id="n-eff-particle">0</span></summary><div class="panel"><div id="g-eff-particle" class="grid"></div></div></details>
      <details><summary>ğŸ’¡ å…‰ãƒ»ã‚°ãƒ­ãƒ¼ï¼åå°„ <span id="n-eff-light">0</span></summary><div class="panel"><div id="g-eff-light" class="grid"></div></div></details>
      <details><summary>ğŸŒŠ æ­ªã¿ãƒ»æ¶²ä½“ãƒ»æ³¢ç´‹ <span id="n-eff-distort">0</span></summary><div class="panel"><div id="g-eff-distort" class="grid"></div></div></details>
      <details><summary>ğŸ§© ãã®ä»– <span id="n-eff-etc">0</span></summary><div class="panel"><div id="g-eff-etc" class="grid"></div></div></details>
    </div>
  </details>

  <details id="d-bg"><summary>â–¼ èƒŒæ™¯ <span id="num-bg">0</span></summary>
    <div class="panel">
      <details><summary>ğŸ“ å ´æ‰€ <span id="n-bg-place">0</span></summary>
        <div class="panel"><div id="g-bg-place" class="grid"></div></div>
      </details>
      <details><summary>ğŸ§© èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ <span id="n-bg-eff">0</span></summary>
        <div class="panel"><div id="g-bg-eff" class="grid"></div></div>
      </details>
    </div>
  </details>

  <details id="d-pose"><summary>â–¼ ãƒãƒ¼ã‚º <span id="num-pose">0</span></summary>
    <div class="panel"><div id="list-pose" class="grid"></div></div>
  </details>

  <details id="d-hair"><summary>â–¼ é«ªå‹ <span id="num-hair">0</span></summary>
    <div class="panel" id="hair-groups"><div id="list-hair" class="grid" style="display:none"></div></div>

    <!-- ãƒ¡ãƒƒã‚·ãƒ¥ï¼ˆç¨®é¡ â†’ ãƒ™ãƒ¼ã‚¹é«ªè‰² â†’ ãƒ¡ãƒƒã‚·ãƒ¥è‰²ï¼‰ -->
    <details id="mesh-nested"><summary>ğŸª¡ ãƒ¡ãƒƒã‚·ãƒ¥ï¼ˆç¨®é¡ â†’ ãƒ™ãƒ¼ã‚¹é«ªè‰² â†’ ãƒ¡ãƒƒã‚·ãƒ¥è‰²ï¼‰</summary>
      <div class="panel">
        <div id="mesh-types-host"></div>
      </div>
    </details>
  </details>
</div>

<div class="foot">
  <div class="row">
    <button id="gen" class="btn">ã‚¿ã‚°ç”Ÿæˆ</button>
    <button id="reset" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="copy" class="btn">ã‚³ãƒ”ãƒ¼</button>
  </div>
  <textarea id="out" class="out" placeholder="generated tags will appear here..."></textarea>
</div>

<div id="toast" class="toast">done</div>
<script>
;(()=>{
const BASE="./";
const FILES={
  presets:(i)=>`${BASE}presets_part${i}.js`,
  faith:(i)=>`${BASE}faith_part${i}.js`,
  background:(i)=>`${BASE}background_part${i}.js`,
  effect:(i)=>`${BASE}effect_part${i}.js`,
  pose:(i)=>`${BASE}pose_part${i}.js`,
  hair:(i)=>`${BASE}hair_part${i}.js`,
};
const CAT_ORDER=["presets","faith","background","effect","pose","hair"];
const CAT_SLOTS={presets:200,faith:200,background:200,effect:200,pose:200,hair:200};
const TOTAL_SLOTS=Object.values(CAT_SLOTS).reduce((a,b)=>a+b,0);

window.__parts=window.__parts||{presets:{},faith:{},background:{},effect:{},pose:{},hair:{}};
function __ensure(p){const w=window.__parts;if(!w[p])w[p]={};return w[p]}
// 3å½¢æ…‹ã‚’è¨±å®¹ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
window.__registerPresetPart=function(a,b,c){
  if(arguments.length===3 && String(a).toLowerCase()==='presets'){ __ensure('presets')[b]=c; return; }
  if(arguments.length===2 && typeof a==='string' && /^presets_part\d+$/i.test(a)){ __ensure('presets')[a]=b; return; }
  __ensure('presets')[a]=b;
};
window.__registerPromptPart=(n,d)=>{__ensure("faith")[n]=d};
window.__registerBackgroundPart=(n,d)=>{__ensure("background")[n]=d};
window.__registerEffectPart=(n,d)=>{__ensure("effect")[n]=d};
window.__registerPosePart=(n,d)=>{__ensure("pose")[n]=d};
window.__registerHairPart=(n,d)=>{__ensure("hair")[n]=d};

const $=s=>document.querySelector(s);
const log=$('#log'); const overallFill=$('#overallFill');
$('#cntEMPTY').textContent=`ç©º ${TOTAL_SLOTS}`; $('#totalMax').textContent=TOTAL_SLOTS;

const metersBox=$('#meters'), meterMap={};
function addMeterRow(label,key){
  const row=document.createElement('div');
  row.className='meterRow';
  row.innerHTML=`
    <div style="min-width:120px">${label}</div>
    <div class="meterBar"><div class="meterFill" id="fill-${key}"></div></div>
    <div class="slot"><span id="ok-${key}" class="badge b-ok">æˆåŠŸ 0</span></div>
    <div class="slot"><span id="ng-${key}" class="badge b-bad">å¤±æ•— 0</span></div>
    <div class="slot"><span id="em-${key}" class="badge b-empty">ç©º ${CAT_SLOTS[key]}</span></div>`;
  metersBox.appendChild(row);
  meterMap[key]={fill:row.querySelector(`#fill-${key}`),ok:row.querySelector(`#ok-${key}`),ng:row.querySelector(`#ng-${key}`),em:row.querySelector(`#em-${key}`),okn:0,ngn:0,emn:CAT_SLOTS[key],total:CAT_SLOTS[key]};
}
['presets','faith','background','effect','pose','hair'].forEach(k=>addMeterRow(k,k));

let totalOk=0,totalNg=0,totalEm=TOTAL_SLOTS,totalRead=0;
$('#cntOK').textContent=`æˆåŠŸ ${totalOk}`; $('#cntNG').textContent=`å¤±æ•— ${totalNg}`; $('#totalRead').textContent=totalRead;
function uiMeterUpdate(key){
  const m=meterMap[key];
  m.ok.textContent=`æˆåŠŸ ${m.okn}`; m.ng.textContent=`å¤±æ•— ${m.ngn}`; m.em.textContent=`ç©º ${m.emn}`;
  const prog=(CAT_SLOTS[key]-m.emn)/m.total;
  m.fill.style.inset=`0 ${(1-prog)*100}% 0 0`;
  $('#cntOK').textContent=`æˆåŠŸ ${totalOk}`; $('#cntNG').textContent=`å¤±æ•— ${totalNg}`;
  $('#cntEMPTY').textContent=`ç©º ${totalEm}`; $('#totalRead').textContent=totalRead;
  const overall=(TOTAL_SLOTS-totalEm)/TOTAL_SLOTS;
  overallFill.style.width=`${(overall*100).toFixed(1)}%`;
}
function writeLog(s){ if(log.textContent)log.textContent+='\n'; log.textContent+=s; log.scrollTop=log.scrollHeight; }

// èª­ã¿è¾¼ã¿ï¼ˆã‚¿ã‚° â†’ fetch+blob ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
function loadViaTag(url, timeout){
  return new Promise((res)=>{
    let done=false; const s=document.createElement('script');
    s.async=true; s.src=url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
    s.onload=()=>{ if(done) return; done=true; res('ok'); };
    s.onerror=()=>{ if(done) return; done=true; res('empty'); };
    document.head.appendChild(s);
    setTimeout(()=>{ if(done) return; done=true; res('hang'); }, timeout||2500);
  });
}
function loadViaFetchBlob(url){
  if(!window.fetch||!window.Blob||!URL||!URL.createObjectURL) return Promise.resolve('empty');
  return fetch(url,{cache:'no-store'})
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
    .then(code=>{
      const blob=new Blob([code],{type:'text/javascript'}); const u=URL.createObjectURL(blob);
      return loadViaTag(u,2500).then(r=>{ try{URL.revokeObjectURL(u)}catch(_){} return r==='ok'?'ok':'empty'; });
    }).catch(()=> 'empty');
}
function tryLoad(url){
  return loadViaTag(url,2500).then(r=>{
    if(r==='ok') return 'ok';
    if(r==='hang'){ writeLog(`âš  èª­ã¿è¾¼ã¿å¾…ã¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ fetch+blob ã«åˆ‡æ›¿: ${url}`); return loadViaFetchBlob(url); }
    return r;
  });
}

/*******************************
 * emptyç™ºç”Ÿã§æ‰“ã¡åˆ‡ã‚Šï¼ˆæ—¢å­˜ä»•æ§˜ã®ç¶­æŒï¼‰
 *******************************/
async function loadCategory(catKey){
  const max=CAT_SLOTS[catKey];
  writeLog(`=== ${catKey} èª­ã¿é–‹å§‹ ===`);
  for(let i=1;i<=max;i++){
    const res=await tryLoad(FILES[catKey](i));
    if(res==='ok'){
      meterMap[catKey].okn++; totalOk++; meterMap[catKey].emn--; totalEm--;
      writeLog(`OK : [${catKey}] part ${i} : OK`); totalRead++;
    }else if(res==='empty'){
      writeLog(`ãªã— : [${catKey}] part ${i} : ãªã—`);
      uiMeterUpdate(catKey);
      break; // â˜… æœ€åˆã® empty ã§ã“ã®ã‚«ãƒ†ã‚´ãƒªã®æ¢ç´¢ã‚’æ‰“ã¡åˆ‡ã‚Š
    }else{
      meterMap[catKey].ngn++; totalNg++; meterMap[catKey].emn--; totalEm--;
      writeLog(`ã‚¨ãƒ©ãƒ¼: [${catKey}] part ${i} : å¤±æ•—`); totalRead++;
    }
    uiMeterUpdate(catKey);
  }
  writeLog(`=== ${catKey} èª­ã¿çµ‚äº† ===`);
}

function mkChk(id,label){
  const lab=document.createElement('label');
  lab.className='chk';
  lab.innerHTML=`<input type="checkbox" data-id="${id}"><span>${label||id}</span>`;
  return lab;
}
const el={
  presets:$('#list-presets'),
  joy:$('#g-joy'), anger:$('#g-anger'), sad:$('#g-sad'), happy:$('#g-happy'), heart:$('#g-heart'),
  eyes:$('#g-eyes'), tear:$('#g-tear'), mouth:$('#g-mouth'), confuse:$('#g-confuse'), tense:$('#g-tense'), shy:$('#g-shy'), etc:$('#g-etc'),
  numPresets:$('#num-presets'), numExpr:$('#num-expr'),
  effRing:$('#g-eff-ring'), effLine:$('#g-eff-line'), effParticle:$('#g-eff-particle'), effLight:$('#g-eff-light'), effDistort:$('#g-eff-distort'), effEtc:$('#g-eff-etc'),
  nEffRing:$('#n-eff-ring'), nEffLine:$('#n-eff-line'), nEffParticle:$('#n-eff-particle'), nEffLight:$('#n-eff-light'), nEffDistort:$('#n-eff-distort'), nEffEtc:$('#n-eff-etc'),
  numEffSubject:$('#num-eff-subject'),
  bgPlace:$('#g-bg-place'), bgEff:$('#g-bg-eff'), nBgPlace:$('#n-bg-place'), nBgEff:$('#n-bg-eff'), numBg:$('#num-bg'),
  listPose:$('#list-pose'), numPose:$('#num-pose'),
  hairGroups:$('#hair-groups'), numHair:$('#num-hair')
};

const emotionDict={
  joy:['smile','grin','laugh','wink','happy','smirk','å–œ','å¬‰','æ¥½','ãƒ‹ãƒ¤'],
  anger:['angry','furious','grit','gritted','frown','annoyed','irritated','æ€’','ãƒ ãƒƒ'],
  sad:['sad','cry','teary','tears','æ¶™','æ³£','å“€'],
  happy:['relax','cheer','sparkle','æ¥½','ãµã‚','calm','serene','composed'],
  heart:['heart','love','â™¡','â¤','ãƒ©ãƒ–'],
  eyes:['eye','eyes','gaze','look','è¦–ç·š','è¦‹é–‹','ç´°ã‚','ä¸Šç›®','blink','drowsy','star','glimmer','gleam'],
  tear:['tear','æ¶™','ã†ã‚‹','æ½¤','teary'],
  mouth:['mouth','lip','å”‡','bite','smug','bashful','tease'],
  confuse:['confuse','å›°æƒ‘','bewilder'],
  tense:['tense','ç·Šå¼µ','nervous','stiffen','freeze'],
  shy:['shy','ã¯ã«ã‹','æ¥','blush','bashful']
};

const effBGHint=['bg','background','backdrop','sakura','petals','leaves','snow','rain','drizzle','mist','haze','veil','cloud','starscape','city','street','forest','sea','mountain','desert','screen'];

const effSubjectGroups=[
  {key:'ring',words:['ring','rim','crown','halo','sparkle','gloss','bokeh']},
  {key:'line',words:['line','ç·š','burst','speed','slash','zigzag']},
  {key:'particle',words:['dust','spark','ember','particle','snow','ashes','filament']},
  {key:'light',words:['light','glow','shine','gleam','glimmer','gloss','highlight','flare']},
  {key:'distort',words:['distort','warp','ripple','wave','liquid','ghost','trench','veil']}
];

function hitAny(s,arr){return arr.some(w=>s.includes(w))}

function putEffSubject(node,grp){
  const map={ring:el.effRing,line:el.effLine,particle:el.effParticle,light:el.effLight,distort:el.effDistort,etc:el.effEtc};
  const cnt={ring:document.getElementById('n-eff-ring'),line:document.getElementById('n-eff-line'),particle:document.getElementById('n-eff-particle'),light:document.getElementById('n-eff-light'),distort:document.getElementById('n-eff-distort'),etc:document.getElementById('n-eff-etc')};
  (map[grp||'etc']).appendChild(node);
  cnt[grp||'etc'].textContent=(+cnt[grp||'etc'].textContent||0)+1;
}

/* ====== ã“ã“ã‹ã‚‰ UI æç”» ====== */
function renderAll(){
  // presets
  let pCount=0;
  for(const k in window.__parts.presets){
    (window.__parts.presets[k]?.presets||[]).forEach(p=>{
      el.presets.appendChild(mkChk(p.id,p.label||p.id)); pCount++;
    });
  }
  el.numPresets.textContent=pCount;

  // è¡¨æƒ…
  const eCnt={joy:0,anger:0,sad:0,happy:0,heart:0,eyes:0,tear:0,mouth:0,confuse:0,tense:0,shy:0,etc:0,total:0};
  const exprMap={joy:el.joy,anger:el.anger,sad:el.sad,happy:el.happy,heart:el.heart,eyes:el.eyes,tear:el.tear,mouth:el.mouth,confuse:el.confuse,tense:el.tense,shy:el.shy,etc:el.etc};
  for(const k in window.__parts.faith){
    (window.__parts.faith[k]?.categories||[]).forEach(c=>{
      (c.items||[]).forEach(it=>{
        const text=`${it.label||''}`.toLowerCase(); let grp='etc';
        for(const g of ['heart','anger','sad','joy','happy']) if(hitAny(text,emotionDict[g])){grp=g;break}
        if(grp==='etc'){ for(const g of ['eyes','tear','mouth','confuse','tense','shy']) if(hitAny(text,emotionDict[g])){grp=g;break} }
        exprMap[grp].appendChild(mkChk(it.id,it.label||it.id)); eCnt[grp]++; eCnt.total++;
      });
    });
  }
  $('#num-expr').textContent=eCnt.total;
  $('#n-joy').textContent=eCnt.joy; $('#n-anger').textContent=eCnt.anger; $('#n-sad').textContent=eCnt.sad; $('#n-happy').textContent=eCnt.happy; $('#n-heart').textContent=eCnt.heart;
  $('#n-eyes').textContent=eCnt.eyes; $('#n-tear').textContent=eCnt.tear; $('#n-mouth').textContent=eCnt.mouth; $('#n-confuse').textContent=eCnt.confuse; $('#n-tense').textContent=eCnt.tense; $('#n-shy').textContent=eCnt.shy; $('#n-etc').textContent=eCnt.etc;

  // èƒŒæ™¯ï¼ˆãƒ•ãƒ©ãƒƒãƒˆä¸€æ¬¡é…ç½®ï¼‰
  let bgPlace=0,bgEff=0;
  function walkBg(cat, inheritedEff){
    const isEffect = inheritedEff || /effect|ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ/i.test(String(cat?.name||''));
    (cat?.items||[]).forEach(it=>{
      const node=mkChk(it.id,it.label||it.id);
      if(isEffect){ $('#g-bg-eff').appendChild(node); bgEff++; } else { $('#g-bg-place').appendChild(node); bgPlace++; }
    });
    (cat?.categories||[]).forEach(sc=>walkBg(sc, isEffect));
  }
  for(const k in window.__parts.background){
    (window.__parts.background[k]?.categories||[]).forEach(c=>walkBg(c,false));
  }
  $('#n-bg-place').textContent=bgPlace; $('#n-bg-eff').textContent=bgEff; $('#num-bg').textContent=bgPlace+bgEff;

  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆè¢«å†™ä½“ï¼‰
  let cRing=0,cLine=0,cParticle=0,cLight=0,cDistort=0,cEtc=0, effSub=0;
  for(const k in window.__parts.effect){
    (window.__parts.effect[k]?.categories||[]).forEach(c=>{
      (c.items||[]).forEach(it=>{
        const text=`${it.label||''} ${it.id}`.toLowerCase();
        if(hitAny(text,effBGHint)){ $('#g-bg-eff').appendChild(mkChk(it.id,it.label||it.id)); bgEff++; return; }
        let grp='etc'; for(const g of effSubjectGroups){ if(hitAny(text,g.words)){ grp=g.key; break; } }
        putEffSubject(mkChk(it.id,it.label||it.id),grp);
        if(grp==='ring')cRing++; else if(grp==='line')cLine++; else if(grp==='particle')cParticle++; else if(grp==='light')cLight++; else if(grp==='distort')cDistort++; else cEtc++;
        effSub++;
      });
    });
  }
  $('#n-bg-eff').textContent=bgEff; $('#num-bg').textContent=bgPlace+bgEff; $('#num-eff-subject').textContent=effSub;
  $('#n-eff-ring').textContent=cRing; $('#n-eff-line').textContent=cLine; $('#n-eff-particle').textContent=cParticle; $('#n-eff-light').textContent=cLight; $('#n-eff-distort').textContent=cDistort; $('#n-eff-etc').textContent=cEtc;

  // ãƒãƒ¼ã‚º
  (function poseGrouping(){
    const host = el.listPose;
    if(!host) return;
    host.innerHTML = '';
    const defs = [
      { key:'stand',title:'ç«‹ã¡ / Standing',kw:['stand','ç›´ç«‹','standing'] },
      { key:'sit',title:'åº§ã‚Š / Sitting',kw:['sit','åº§ã‚Š','chair','sofa'] },
      { key:'kneel',title:'è†ãƒ»ã—ã‚ƒãŒã¿ / Kneel & Crouch',kw:['kneel','crouch','squat','æ­£åº§'] },
      { key:'hands',title:'æ‰‹ãƒ»è…• / Hands & Arms',kw:['hand-','hands-','finger','thumb','peace','ãƒãƒ¼ãƒˆãƒãƒ³ãƒ‰','ãƒ”ãƒ¼ã‚¹','é ¬æ–','æŒ‡'] },
      { key:'upper',title:'ä¸ŠåŠèº« / Upper Body',kw:['shoulder','torso','chest','èƒŒ','èƒ¸'] },
      { key:'head',title:'é ­ãƒ»è¦–ç·š / Head & Gaze',kw:['head','look','gaze','profile','camera','angle','è¦–ç·š','æ¨ªé¡”'] },
      { key:'dynamic',title:'å‹•ããƒ»ãƒãƒ©ãƒ³ã‚¹ / Dynamic',kw:['walk','run','jump','spin','lean','reach','push','pull','slide','sprint','skip','twirl'] },
      { key:'dance',title:'ãƒ€ãƒ³ã‚¹ãƒ»èˆå° / Dance & Stage',kw:['dance','ballet','stage','idol','spotlight','sing','cheer'] },
      { key:'lying',title:'å¯è»¢ã³ãƒ»ãƒªãƒ©ãƒƒã‚¯ã‚¹ / Lying & Relax',kw:['lying','recline','nap','bed','sleep','stretch on bed'] },
      { key:'daily',title:'æ—¥å¸¸ãƒ»å‰µä½œãƒ»ä»•äº‹ / Daily & Creative',kw:['writing','painting','guitar','violin','cook','pan','chopping','plating','typing','presentation','phone','desk','office','kitchen'] },
      { key:'sports',title:'ã‚¹ãƒãƒ¼ãƒ„ / Sports & Action',kw:['soccer','basketball','tennis','baseball','golf','volleyball','rugby','swimming','boxing','mma','fencing','parkour','skateboard','snowboard','surfing','marathon','weightlifting'] },
      { key:'combat',title:'æ ¼é—˜ãƒ»æ­¦å™¨ / Combat & Action',kw:['sword','guard','kick','punch','aim','bow','rifle','weapon','shield','dodge','parry','finisher','stance','martial','archery','throwing'] },
      { key:'pair',title:'ãƒšã‚¢ãƒ»ã‚°ãƒ«ãƒ¼ãƒ— / Pair & Group',kw:['duo','pair','group','two-person','back-to-back','lineup','huddle','standing in a line','å††é™£'] },
      { key:'jpn',title:'å’Œé¢¨ãƒ»ç€ç‰© / Japanese',kw:['samurai','katana','kimono','tea ceremony','sumo','kendo','naginata','seiza','æ­¦å£«','ç€ç‰©','ãŠç‚¹å‰','ç›¸æ’²'] },
      { key:'west',title:'è¥¿æ´‹ãƒ»å®®å»· / Western',kw:['curtsy','gentleman','salon toast','waltz','tango','hand kiss','dress'] },
      { key:'sf',title:'SFãƒ»ãƒ¡ã‚« / SF & Mecha',kw:['mech','cockpit','pilot','launch','mecha','sf','arm cannon','railgun','hatch'] },
      { key:'loc',title:'ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ / Locations',kw:['loc-'] },
      { key:'extra',title:'ã‚¨ã‚¯ã‚¹ãƒˆãƒ© / Extras',kw:['pose-','expressive','shrug','finger guns','casual salute'] },
      { key:'others',title:'ãã®ä»– / Others',kw:[] }
    ];
    const groups={};
    defs.forEach(d=>{
      const wrap=document.createElement('details'); wrap.open=false;
      const sum=document.createElement('summary'); const count=document.createElement('span'); count.id=`cnt-${d.key}`; count.textContent='0';
      sum.textContent=d.title+' '; sum.appendChild(count);
      const panel=document.createElement('div'); panel.className='panel';
      const grid=document.createElement('div'); grid.className='grid'; grid.id=`g-${d.key}`;
      panel.appendChild(grid); wrap.appendChild(panel); wrap.insertBefore(sum,panel);
      host.appendChild(wrap); groups[d.key]={grid,countEl:count,n:0,def:d};
    });
    function pickGroup(label,id){
      const t = `${label||''} ${id||''}`.toLowerCase();
      if (id && id.startsWith('loc-')) return 'loc';
      for (const d of defs){ if (d.key==='others') continue; if (d.kw.some(k=>t.includes(k))) return d.key; }
      return 'others';
    }
    let totalPose=0;
    const src = window.__parts?.pose||{};
    for(const k in src){
      (src[k]?.categories||[]).forEach(c=>{
        (c.items||[]).forEach(it=>{
          const key=pickGroup(it.label,it.id);
          groups[key]?.grid.appendChild(mkChk(it.id,it.label||it.id));
          if(groups[key]){ groups[key].n++; totalPose++; }
        });
      });
    }
    Object.values(groups).forEach(g=>g.countEl.textContent=g.n);
    el.numPose.textContent=totalPose;
  })();

  // é«ªå‹ï¼ˆæ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼‰
  (function hairGrouping(){
    const host = el.hairGroups;
    if(!host) return;
    host.innerHTML = '';
    const defs = [
      { key:'pony',title:'ğŸ ãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ« / Ponytails',kw:['ponytail','pony','side-ponytail','twin-ponies'] },
      { key:'twin',title:'ğŸ€ ãƒ„ã‚¤ãƒ³ãƒ»ã‚µã‚¤ãƒ‰ / Twin & Side',kw:['twin-tail','twin buns','twin','side-tail','side-ponytail'] },
      { key:'bun',title:'ğŸŸ¤ ãŠå›£å­ãƒ»ã‚¢ãƒƒãƒ— / Buns & Updos',kw:['bun','updo','chignon','french twist','roll updo','space buns'] },
      { key:'short',title:'âœ‚ï¸ ã‚·ãƒ§ãƒ¼ãƒˆ / Short',kw:['short','pixie','bixie','bob','buzzcut','mullet'] },
      { key:'medium',title:'ğŸ“ ãƒŸãƒ‡ã‚£ã‚¢ãƒ  / Medium',kw:['midi','medium','lob'] },
      { key:'long',title:'ğŸ’« ãƒ­ãƒ³ã‚° / Long',kw:['long','mermaid','swan','ribbon-tie long'] },
      { key:'bangs',title:'ğŸ§¢ å‰é«ª / Bangs',kw:['bang','fringe','curtain bangs','bottleneck'] },
      { key:'braid',title:'ğŸ§¶ ç·¨ã¿ãƒ»ãƒ–ãƒ¬ã‚¤ã‚º / Braids',kw:['braid','braided','fishtail','dutch','crown braid','rope'] },
      { key:'acc',title:'ğŸ—ï¸ ã‚¢ã‚¯ã‚»ä»˜ã / Accessories',kw:['ribbon','hairpin','tiara','clip','barrette','flower','pearl','beads','chain','scrunchie'] },
      { key:'fant',title:'ğŸª„ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒ»SF / Fantasy & SF',kw:['elf','demon','angel','fairy','goddess','knight','cyber','neon','android','hologram','mecha','space','vr','ai','samurai armor','gladiator','berserker'] },
      { key:'cult',title:'ğŸ› æ–‡åŒ–ãƒ»ä¼çµ± / Cultural & Traditional',kw:['samurai','maiko','geisha','miko','viking','egyptian','indi','arab','shrine','edo','kimono','tribal'] },
      { key:'sports',title:'ğŸƒ ã‚¹ãƒãƒ¼ãƒ„ / Sports & Action',kw:['runner','athlete','gym','fighter','martial','swimmer','dancer','basketball','soccer','tennis'] },
      { key:'casual',title:'ğŸ§µ ã‚«ã‚¸ãƒ¥ã‚¢ãƒ« / Casual & Everyday',kw:['casual','daily','schoolgirl','loose','messy','relaxed','carefree','quick-tie'] },
      { key:'pastel',title:'ğŸ¨ ãƒ‘ã‚¹ãƒ†ãƒ« / Pastel Colors',kw:['pastel'] },
      { key:'metallic',title:'âœ¨ ãƒ¡ã‚¿ãƒªãƒƒã‚¯ / Metallic Colors',kw:['metallic','chrome'] },
      { key:'glow',title:'ğŸ’¡ ç™ºå…‰ãƒ»åå¿œ / Glow & Reactive',kw:['glow','bioluminescent','phosphor','uv','radioactive','neon'] },
      { key:'gradient',title:'ğŸŒˆ ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ / Gradients',kw:['gradient','ombre'] },
      { key:'basic',title:'ğŸ§ª ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ï¼†æ‹¡å¼µè‰² / Basic Colors',kw:['hair-','-hair','brown','blonde','red','silver','white','black','auburn','ash','burgundy','rose gold','highlight','gloss','smoky','uv-reactive'] },
      { key:'natural',title:'ğŸƒ è‡ªç„¶ãƒ»å…ƒç´  / Natural & Elements',kw:['forest','leaf','stone','sand','earth','river','ocean','lava','crystal','aqua','sunset'] },
      { key:'others',title:'â–¶ ãã®ä»– / Others',kw:[] },
    ];
    const groups={};
    defs.forEach(d=>{
      const dd=document.createElement('details'); dd.open=false;
      const sm=document.createElement('summary'); const cnt=document.createElement('span'); cnt.id=`cnt-hair-${d.key}`; cnt.textContent='0';
      sm.textContent=d.title+' '; sm.appendChild(cnt);
      const panel=document.createElement('div'); panel.className='panel';
      const grid=document.createElement('div'); grid.className='grid'; grid.id=`g-hair-${d.key}`;
      panel.appendChild(grid); dd.appendChild(sm); dd.appendChild(panel);
      host.appendChild(dd);
      groups[d.key]={grid,countEl:cnt,n:0,def:d};
    });
    function pick(label,id){
      const t=`${label||''} ${id||''}`.toLowerCase();
      for(const d of defs){ if(d.key==='others') continue; if(d.kw.some(k=>t.includes(k))) return d.key; }
      return 'others';
    }
    let total=0;
    const src = window.__parts?.hair||{};
    for(const k in src){
      (src[k]?.categories||[]).forEach(c=>{
        (c.items||[]).forEach(it=>{
          const key=pick(it.label,it.id);
          groups[key]?.grid.appendChild(mkChk(it.id,it.label||it.id));
          if(groups[key]){ groups[key].n++; total++; }
        });
      });
    }
    Object.values(groups).forEach(g=>g.countEl.textContent=g.n);
    el.numHair.textContent=total;
  })();

  // ===== ãƒ¡ãƒƒã‚·ãƒ¥3æ®µUIã®æ§‹ç¯‰ =====
  buildNestedMeshUI();

  // ===== å ´æ‰€ã®æŠ˜ã‚ŠãŸãŸã¿ãƒ„ãƒªãƒ¼ã‚’æœ€å¾Œã«ç”Ÿæˆãƒ»ãƒ•ãƒ©ãƒƒãƒˆé‡è¤‡ã‚’é™¤å»ï¼ˆå¾©å…ƒï¼‰ =====
  buildPlaceTreeAfterRender(); // FIX: è¿½åŠ å‘¼ã³å‡ºã—
}/* ===== ãƒ¡ãƒƒã‚·ãƒ¥3æ®µUIï¼šhair_partã‹ã‚‰è‡ªå‹•åé›† ===== */
function buildNestedMeshUI(){
  const host = document.getElementById('mesh-types-host') || document.getElementById('mesh-composer');
  if (!host) return;
  host.innerHTML = '';

  const FIX_TYPES = [
    { id:'inner color mesh', label:'ã‚¤ãƒ³ãƒŠãƒ¼ã‚«ãƒ©ãƒ¼ãƒ¡ãƒƒã‚·ãƒ¥ / inner color mesh' },
    { id:'peekaboo mesh',    label:'ãƒ”ãƒ¼ã‚«ãƒ–ãƒ¼ãƒ¡ãƒƒã‚·ãƒ¥ / peekaboo mesh' },
    { id:'half & half color',label:'å·¦å³ãƒãƒ¼ãƒ•ã‚«ãƒ©ãƒ¼ / half & half color' },
    { id:'highlight streaks',label:'ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ã‚¯ / highlight streaks' },
  ];
  const FIX_BASES = [
    {id:'none',label:'æŒ‡å®šãªã—'},
    {id:'black',label:'black'},
    {id:'brown',label:'brown'},
    {id:'blonde',label:'blonde'},
    {id:'ash gray',label:'ash gray'},
    {id:'white',label:'white'},
    {id:'pastel pink',label:'pastel pink'},
  ];
  const FIX_COLORS = ['red','blue','green','purple','neon pink','metallic gold','gradient purpleâ†’blue'];

  const parts = (window.__parts && window.__parts.hair) ? window.__parts.hair : {};
  const byId = new Map();
  const EXTRA_TYPE_IDS = new Set([
    'inner-color','underlayer-streaks','money-piece','front-streaks','side-streaks','bangs-streaks',
    'chunky-streaks','bold-highlights','fine-streaks','mixed-streaks'
  ]);
  const BASE_NAME_HINTS = /base.*hair|ãƒ™ãƒ¼ã‚¹.*é«ªè‰²/i;

  for (const k in parts){
    const catArr = parts[k]?.categories || [];
    catArr.forEach(cat=>{
      const isBaseCat = BASE_NAME_HINTS.test(String(cat?.name||''));
      (cat.items||[]).forEach(it=>{
        const id = String(it.id||'').trim();
        const label = it.label || id;
        if (!id) return;
        if (id.startsWith('mesh-') || EXTRA_TYPE_IDS.has(id)){
          if (!byId.has(id)) byId.set(id, {id, label, kind:'type'});
        } else if (id.startsWith('hair-')){
          const kind = isBaseCat ? 'base' : 'color';
          if (!byId.has(id)) byId.set(id, {id, label, kind});
        }
      });
    });
  }

  const TYPES  = [...FIX_TYPES.map(x=>({id:x.id,label:x.label}))];
  const BASES  = [...FIX_BASES.map(x=>({id:x.id,label:x.label}))];
  const COLORS = [...FIX_COLORS];

  for (const v of byId.values()){
    if (v.kind==='type'){ TYPES.push({id:v.id, label:`${v.label} / ${v.id}`}); }
    else if (v.kind==='base'){ BASES.push({id:v.id, label:`${v.label}`}); }
    else if (v.kind==='color'){ if (!BASES.some(b=>b.id===v.id)) COLORS.push(v.id); }
  }

  const mkDetails = (summaryText) => {
    const d = document.createElement('details'); d.className = 'panel'; d.open = false;
    const s = document.createElement('summary'); s.textContent = summaryText; d.appendChild(s);
    const p = document.createElement('div'); p.className = 'panel grid'; d.appendChild(p);
    return {wrap:d, grid:p};
  };
  const mkChk2 = (attrs, text) => {
    const lab = document.createElement('label'); lab.className='chk';
    const input = document.createElement('input'); input.type='checkbox';
    Object.entries(attrs).forEach(([k,v])=>input.setAttribute(k,v));
    const span = document.createElement('span'); span.textContent = text;
    lab.appendChild(input); lab.appendChild(span);
    return lab;
  };

  const a = mkDetails('ğŸ§µ ãƒ¡ãƒƒã‚·ãƒ¥ã®ç¨®é¡');  TYPES.forEach(t=>a.grid.appendChild(mkChk2({'data-m2':'type','value':t.id}, t.label)));
  const b = mkDetails('ğŸª„ ãƒ™ãƒ¼ã‚¹ã®é«ªè‰²');    BASES.forEach(c=>b.grid.appendChild(mkChk2({'data-m2':'base','value':c.id}, c.label)));
  const c = mkDetails('ğŸŒˆ ãƒ¡ãƒƒã‚·ãƒ¥ã®è‰²');    COLORS.forEach(col=>c.grid.appendChild(mkChk2({'data-m2':'color','value':col}, col)));

  host.appendChild(a.wrap); host.appendChild(b.wrap); host.appendChild(c.wrap);
}

/* ===== ãƒ¡ãƒƒã‚·ãƒ¥ã‚¿ã‚°ç”Ÿæˆï¼ˆåŒè‰²äºŒé‡å¯¾ç­–ï¼‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‡ªå‹•é¸æŠãªã—ï¼‰ ===== */
function buildNestedMeshTokens(){
  const wraps = document.querySelectorAll('[data-m2="type"], [data-m2="base"], [data-m2="color"]');
  if (!wraps.length) return [];

  const types  = [...document.querySelectorAll('[data-m2="type"]:checked')].map(i=>i.value);
  const bases  = [...document.querySelectorAll('[data-m2="base"]:checked')].map(i=>i.value);
  const colors = [...document.querySelectorAll('[data-m2="color"]:checked')].map(i=>i.value);

  const toHair = (s)=> s && (/( hair)$/i.test(s) ? s : `${s} hair`);

  const out = [];
  const T = types.length ? types : []; // FIX: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‡ªå‹•é¸æŠã‚’ã‚„ã‚ã‚‹

  // ã„ãšã‚Œã‹ãŒæœªé¸æŠã§ã‚‚ã€é¸ã°ã‚ŒãŸã‚‚ã®ã ã‘ã§çµ„ã¿ç«‹ã¦
  const typesList = T.length ? T : [null];
  const baseList  = bases.length ? bases : [null];
  const colorList = colors.length ? colors : [null];

  typesList.forEach(t=>{
    baseList.forEach(b=>{
      colorList.forEach(c=>{
        const toks = [];
        if (t) toks.push(toHair(t));              // ç¨®é¡ã¯ã€Œâ€¦ hairã€è¡¨ç¾ã«çµ±ä¸€
        if (b && b!=='none') toks.push(toHair(b));
        if (c) toks.push(toHair(c));
        // FIX: æ­£è¦åŒ–ã‚­ãƒ¼ã§é‡è¤‡æŠ‘æ­¢
        const seen=new Set();
        const norm = s=>String(s).toLowerCase().replace(/\s+/g,' ').trim();
        const uniq = toks.filter(x=>{const k=norm(x); if(seen.has(k)) return false; seen.add(k); return true;});
        if (uniq.length) out.push(uniq.join(', '));
      });
    });
  });

  return out;
}

/* ===== èƒŒæ™¯ã€Œå ´æ‰€ã€ãƒ„ãƒªãƒ¼å¾©å…ƒï¼šãƒ•ãƒ©ãƒƒãƒˆé‡è¤‡ã®è‡ªå‹•å‰Šé™¤ ===== */
const PLACE_SUBS = {
  "å­¦æ ¡":["æ•™å®¤","é‹å‹•å ´","å»Šä¸‹","æ ¡é–€","å›³æ›¸å®¤","å±‹ä¸Š"],
  "ç—…é™¢":["ç—…å®¤","æ‰‹è¡“å®¤","å—ä»˜","å»Šä¸‹","å±‹ä¸Š"],
  "åŸ":["ç‰åº§ã®é–“","åŸé–€","å›å»Š","åº­åœ’","å¡”"],
  "éƒ½å¸‚":["åºƒå ´","å¸‚å ´","ä½å®…è¡—","é«˜å±¤ãƒ“ãƒ«è¡—"],
  "å®¤å†…":["ãƒªãƒ“ãƒ³ã‚°","å¯å®¤","å°æ‰€","å»Šä¸‹","ç„é–¢"],
  "å®‡å®™":["å®‡å®™èˆ¹å†…éƒ¨","å®‡å®™ç©ºé–“","æƒ‘æ˜Ÿè¡¨é¢","åŸºåœ°","SFéƒ½å¸‚"],
  "å¯ºé™¢":["æœ¬å ‚","å¢ƒå†…","å›å»Š"],
  "ç¥ç¤¾":["æœ¬æ®¿","é³¥å±…","å‚é“"],
  "å›³æ›¸é¤¨":["é–²è¦§å®¤","æ›¸åº«","å»Šä¸‹"],
  "åšç‰©é¤¨":["å±•ç¤ºå®¤","ãƒ›ãƒ¼ãƒ«","å»Šä¸‹"],
  "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³":["å®¢å¸­","å¨æˆ¿","å€‹å®¤"],
  "ã‚«ãƒ•ã‚§":["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ãƒ†ãƒ¼ãƒ–ãƒ«å¸­","ãƒ†ãƒ©ã‚¹å¸­"]
};
function __bgEnsureHeadDynamic(name){
  let det = document.querySelector(`details[data-bg-head="${name}"]`);
  if (det) return det.querySelector('.grid');
  det = document.createElement('details'); det.setAttribute('data-bg-head', name); det.open = false;
  const sum = document.createElement('summary'); sum.textContent = name; det.appendChild(sum);
  const panel = document.createElement('div'); panel.className = 'panel';
  const grid = document.createElement('div'); grid.className = 'grid'; grid.id = `bg-place-${name}`;
  panel.appendChild(grid); det.appendChild(panel);
  document.getElementById('g-bg-place')?.appendChild(det);
  return grid;
}
function __bgEnsureSub(headName, subName){
  const headGrid = __bgEnsureHeadDynamic(headName);
  const headDet = headGrid.closest('details');
  let sub = headDet.querySelector(`details[data-bg-sub="${headName}:${subName}"]`);
  if (sub) return sub.querySelector('.grid');
  sub = document.createElement('details'); sub.setAttribute('data-bg-sub', `${headName}:${subName}`); sub.open = false;
  const s = document.createElement('summary'); s.textContent = subName; sub.appendChild(s);
  const p = document.createElement('div'); p.className = 'panel';
  const g = document.createElement('div'); g.className = 'grid'; g.id = `bg-sub-${headName}-${subName}`;
  p.appendChild(g); sub.appendChild(p); headDet.appendChild(sub);
  return g;
}
function walkBg_place_dynamic(cat){
  const name = String(cat?.name||'').trim();
  if (!name) return;
  if (/effect|ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ/i.test(name)) return; // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç³»ã¯é™¤å¤–

  const headGrid = __bgEnsureHeadDynamic(name);

  if (PLACE_SUBS[name]) {
    (cat?.categories||[]).forEach(sub=>{
      const subName = String(sub?.name||'').trim();
      if (PLACE_SUBS[name].includes(subName)) {
        const subGrid = __bgEnsureSub(name, subName);
        (sub?.items||[]).forEach(it=>subGrid.appendChild(mkChk(it.id, it.label||it.id)));
      } else {
        (sub?.items||[]).forEach(it=>headGrid.appendChild(mkChk(it.id, it.label||it.id)));
      }
    });
    (cat?.items||[]).forEach(it=>headGrid.appendChild(mkChk(it.id, it.label||it.id)));
  } else {
    (cat?.items||[]).forEach(it=>headGrid.appendChild(mkChk(it.id, it.label||it.id)));
    (cat?.categories||[]).forEach(sc=>walkBg_place_dynamic(sc));
  }
}
function buildPlaceTreeAfterRender(){
  try{
    const src=(window.__parts&&window.__parts.background)||{};
    // æ—¢å­˜ã®è‡ªå‹•ç”Ÿæˆãƒ„ãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ‰‹å‹•é…ç½®ã¯è§¦ã‚‰ãªã„ï¼‰
    document.querySelectorAll('details[data-bg-head]').forEach(d=>d.remove());
    const usedIds=new Set();

    for(const k in src){
      (src[k]?.categories||[]).forEach(cat=>{
        walkBg_place_dynamic(cat);
      });
    }

    // ä½¿ã‚ã‚ŒãŸIDã‚’åé›†
    document.querySelectorAll('details[data-bg-head] input[type="checkbox"][data-id]')
      .forEach(i=>usedIds.add(i.getAttribute('data-id')));

    // ãƒ•ãƒ©ãƒƒãƒˆå´ã‹ã‚‰é‡è¤‡ã‚’å‰Šé™¤ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ã«å…¥ã£ãŸã‚‚ã®ã¯æ¶ˆã™ï¼‰
    document.querySelectorAll('#g-bg-place > label.chk > input[type="checkbox"][data-id]')
      .forEach(inp=>{
        const id=inp.getAttribute('data-id');
        if(usedIds.has(id)){
          const lab=inp.closest('label.chk'); if(lab) lab.remove();
        }
      });

    // ã‚«ã‚¦ãƒ³ãƒˆå†åŒæœŸ
    const placeCount =
      document.querySelectorAll('#g-bg-place > label.chk input[type="checkbox"]').length +
      document.querySelectorAll('details[data-bg-head] .grid > label.chk input[type="checkbox"]').length;
    const effCount =
      document.querySelectorAll('#g-bg-eff > label.chk input[type="checkbox"]').length;
    const setText=(s,v)=>{const n=document.querySelector(s); if(n) n.textContent=v;};
    setText('#n-bg-place', placeCount);
    setText('#n-bg-eff',   effCount);
    setText('#num-bg',     placeCount + effCount);
  }catch(e){ console.warn('place-tree build skipped:', e); }
}

/* ===== å®Ÿè¡Œï¼†ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
function run(){
  log.textContent=''; totalOk=0; totalNg=0; totalEm=TOTAL_SLOTS; totalRead=0;
  for(const k of CAT_ORDER){ meterMap[k].okn=0; meterMap[k].ngn=0; meterMap[k].emn=CAT_SLOTS[k]; uiMeterUpdate(k); }
  (async()=>{
    for(const k of CAT_ORDER){ await loadCategory(k); }
    writeLog('=== ãƒ­ãƒ¼ãƒ‰çµ‚äº† ==='); renderAll();
  })();
}

const toast=$('#toast'); let toastTimer=null;
function showToast(msg){
  toast.textContent=msg; toast.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove('show'),3000);
}

$('#reloadBtn').addEventListener('click', ()=>{
  if(window.__pb_running) return; // äºŒé‡èµ·å‹•æŠ‘æ­¢
  window.__pb_running=true; run(); setTimeout(()=>window.__pb_running=false,0);
});
$('#reset').addEventListener('click', ()=>{
  document.querySelectorAll('input[type="checkbox"]').forEach(i=>i.checked=false);
  $('#out').value=''; showToast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
});
$('#copy').addEventListener('click', ()=>{
  navigator.clipboard.writeText($('#out').value||''); showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
});

/* hair å‡ºåŠ›ï¼šå¯¾è±¡è‰²ã®ç¶²ç¾…ï¼‹", hair" ã§ã¯ãªãåŒä¸€ãƒˆãƒ¼ã‚¯ãƒ³æ‹¡å¼µã€é‡è¤‡ hair é™¤å»ï¼ˆæ—¢å­˜ï¼‰ */
function formatHairTokens(ids){
  const lower = (s)=>String(s||'').toLowerCase();
  const hasHairWord = (t)=> t.includes(' hair') || t.endsWith('-hair') || t.startsWith('hair-');

  const colorMatchers = [
    'pastel','metallic','glow','bioluminescent','phosphor','radioactive','neon',
    'gradient','ombre','uv-reactive','highlight','gloss','smoky',
    'uv-reactive yellow','uv-reactive orange',
    'ash smoky gray','chocolate brown gloss','wine red gloss',
    'blonde highlights','brown highlights'
  ];
  const colorRegexTail = /(black|brown|blonde|red|silver|white|gold|blue|green|pink|purple|pearl|copper|chrome|emerald)$/;

  const isColor = (id)=>{
    const t = lower(id);
    return (
      colorMatchers.some(k=>t.includes(k)) ||
      colorRegexTail.test(t) ||
      t.startsWith('hair-') || t.endsWith('-hair')
    );
  };
  const isStyle = (id)=>{
    const t = lower(id);
    return /ponytail|twin|bun|updo|chignon|bob|pixie|pageboy|bang|fringe|braid|afro|mohawk|dread|undercut|hime|nihongami|mullet|lob|shag|wolf|wavy|curly|straight|perm/.test(t);
  };

  const mapped = ids.map((raw)=>{
    const id = String(raw);
    const t = lower(id);
    if ((isColor(id) || isStyle(id)) && !hasHairWord(t)){
      return id + ' hair';
    }
    return id;
  });

  return mapped.filter(tok => lower(tok).trim() !== 'hair');
}

/* === ã‚¿ã‚°ç”Ÿæˆï¼ˆå …ç‰¢åŒ–ãƒ»å¤šé‡/æœªãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢ãƒ»é‡è¤‡æ­£è¦åŒ–ï¼‰ === */
(function bindGen(){
  const genBtn = document.getElementById('gen');
  if(!genBtn) return;
  if(genBtn.dataset.bound==='1') return;
  genBtn.dataset.bound='1';
  genBtn.addEventListener('click', () => {
    try{
      const baseIds = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(el => el.getAttribute('data-id') || '')
        .map(s => String(s).trim())
        .filter(Boolean);

      const formatted = (typeof formatHairTokens === 'function') ? formatHairTokens(baseIds) : baseIds;
      const mesh = (typeof buildNestedMeshTokens === 'function') ? buildNestedMeshTokens() : [];

      const seen = new Set(); const result = [];
      const key = (t)=>String(t||'').toLowerCase().replace(/\s+/g,' ').trim(); // FIX: å¼·åŒ–ã‚­ãƒ¼
      [...formatted, ...mesh].forEach(tok => {
        const t = String(tok || '').trim(); if(!t) return;
        const k = key(t); if (seen.has(k)) return;
        seen.add(k); result.push(t);
      });

      const out = document.getElementById('out'); if (out) out.value = result.join(', ');
      showToast('ã‚¿ã‚°ç”Ÿæˆã—ã¾ã—ãŸ');
    }catch(err){ console.error('gen failed:', err); }
  });
})();

/* === åˆå›ã‚ªãƒ¼ãƒˆå®Ÿè¡Œï¼ˆé‡è¤‡èµ·å‹•ã‚¬ãƒ¼ãƒ‰ï¼‰ === */
if(!window.__pb_booted){
  window.__pb_booted=true;
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', run, {once:true}); }
  else { run(); }
}
})();
</script>

<!-- Partç•ªå·ã‚ªãƒ¼ãƒˆè¨˜æ†¶ï¼ˆæ—¢å­˜ãã®ã¾ã¾ï¼‰ -->
<script>
(()=>{
  const INITIAL = { presets:33, faith:32, effect:33, background:1, pose:0, hair:0 };
  const KEY='pbPartCounters';
  const load=()=>{ try{ return JSON.parse(localStorage.getItem(KEY))||{}; }catch{ return {}; } };
  const save=(obj)=>localStorage.setItem(KEY,JSON.stringify(obj));
  const state=Object.assign({presets:0,faith:0,effect:0,background:0,pose:0,hair:0},load());
  for(const k in INITIAL) state[k]=Math.max(Number(state[k]||0),Number(INITIAL[k]||0)); save(state);
  function parseName(name, fallbackCat){
    let cat=fallbackCat||'', idx=0;
    if(typeof name==='string' && name.includes('_part')){
      const m=name.match(/^([a-zA-Z]+)_part(\d+)$/); if(m){cat=m[1]; idx=parseInt(m[2],10)||0;}
    } else if(typeof name==='string' && /^part\d+$/.test(name)){
      idx=parseInt(name.replace('part',''),10)||0;
    }
    const norm={presets:'presets',faith:'faith',effect:'effect',background:'background',pose:'pose',hair:'hair',prompt:'faith'};
    cat=norm[cat]||(norm[fallbackCat]||''); return {cat,idx};
  }
  function bump(cat,idx){
    if(!cat||!idx) return; const cur=Number(state[cat]||0);
    if(idx>cur){ state[cat]=idx; save(state); }
  }
  const _orig={
    preset:window.__registerPresetPart, faith:window.__registerPromptPart, effect:window.__registerEffectPart,
    bg:window.__registerBackgroundPart, pose:window.__registerPosePart, hair:window.__registerHairPart
  };
  window.__registerPresetPart=function(name,data){
    try{const {cat,idx}=parseName(name,'presets'); bump(cat,idx);}catch{}
    return _orig.preset&&_orig.preset.apply(this,arguments);
  };
  window.__registerPromptPart=function(name,data){
    try{const {cat,idx}=parseName(name,'faith'); bump(cat,idx);}catch{}
    return _orig.faith&&_orig.faith.apply(this,arguments);
  };
  window.__registerEffectPart=function(name,data){
    try{const {cat,idx}=parseName(name,'effect'); bump(cat,idx);}catch{}
    return _orig.effect&&_orig.effect.apply(this,arguments);
  };
  window.__registerBackgroundPart=function(name,data){
    try{const {cat,idx}=parseName(name,'background'); bump(cat,idx);}catch{}
    return _orig.bg&&_orig.bg.apply(this,arguments);
  };
  window.__registerPosePart=function(name,data){
    try{const {cat,idx}=parseName(name,'pose'); bump(cat,idx);}catch{}
    return _orig.pose&&_orig.pose.apply(this,arguments);
  };
  window.__registerHairPart=function(name,data){
    try{const {cat,idx}=parseName(name,'hair'); bump(cat,idx);}catch{}
    return _orig.hair&&_orig.hair.apply(this,arguments);
  };
  window.__pbGetNextIndex=function(cat){
    const n=Number((load()[cat]??state[cat])||0); return (n+1);
  };
})();
</script>
<script src="./enhance_addons.js"></script>
</body>
</html>